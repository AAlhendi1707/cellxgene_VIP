<html>
  <head>
    <script type="text/javascript" src="static/jquery.min.js"></script>
    <!-- for datatables -->
    <script type="text/javascript" src="static/DataTables/datatables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/DataTables/datatables.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>

      .splitter {
          display: flex;
          width: 100%;
      }
      
      #separator {  
          cursor: col-resize;
          min-width: 6px;
          background-color: #aaa;
          background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAhCAQAAABOpSL+AAAAIklEQVR4AWMwbb/PdR+JZDD9f1/oPhI5sgVGBSruc9xHIgGdSQqqQJGkRgAAAABJRU5ErkJggg==') center center no-repeat #F1F1F1;
      /* prevent browser's built-in drag from interfering */
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
      }
      
      #panel-left {
          background-color: #dde;
          width: 20%;
          white-space: nowrap;
      }
      
      #panel-right {
          background-color: #fff;
          width: 80%;
      }
      #separator, #panel-left, #panel-right {
          vertical-align: top; 
      }

      .block {
        display: block;
        width: 100%;
        border: none;
        background-color: #B6B6B6;
        color: white;
        padding: 4px 28px;
        font-size: 18px;
        cursor: pointer;
        text-align: center;
      }
      .block:hover {
        background-color: #ffff33;
        color: black;
      }

      .tab {
        float: left;
        width: 100%;
        height: 100%;
        
        border: 1px solid #ccc;
        background-color: #f1f1f1;
      }
      .tab button {
        display: block;
        width: 100%;
        text-align: left;
        
        background-color: inherit;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 5px 10px;
        transition: 0.3s;
      }
      .tab button:hover {
        background-color: #ddd;
      }
      .tab button.active {
        background-color: #ccc;
      }
      .tabcontent {
        float: left;
        border-left: none;
        width:100%;
        
        display: none;
        padding: 0px 10px;
      }

      h3 {
        display: block;
        font-size: 1.17em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 0;
        margin-right: 0;
        font-weight: bold;
      }
      .loading {
          width: 50%;
          height: auto;
          position: relative;
      }
      .loading-wheel {
          width: 70px;
          height: 70px;
          margin-top: -60px;
          margin-left: -60px;
          
          position: absolute;
          top: 50%;
          left: 50%;
          
          border-width: 30px;
          border-radius: 50%;
          -webkit-animation: spin 2s linear infinite;
      }
      .style-2 .loading-wheel {
          border-style: double;
          border-color: #99f transparent;
      }
      @-webkit-keyframes spin {
          0% {
              -webkit-transform: rotate(0);
          }
          100% {
              -webkit-transform: rotate(-360deg);
          }
      }
      
      tr:nth-child(even) {background-color: #f2f2f2;}
      input[type=number]{
        width: 60px;
      }
      input,textarea,select{ font-size: 14px; }
    </style>
  </head>
<body>
<div class="splitter">
	<div id="panel-left">
    <div class="tab">
      <button class="tablinks" onclick="selFun(event, 'ADDG')">Add Genes</button>
      <button class="tablinks" onclick="selFun(event, 'SGV');if($('#SGVgene').val() == null) $('#SGVnote').text('Please add genes either from the VIP menu or the main window');">Violin</button>
      <button class="tablinks" onclick="selFun(event, 'PGV')">Stacked Violin</button>
      <button class="tablinks" onclick="selFun(event, 'HEAT')">Heatmap</button>
      <button class="tablinks" onclick="selFun(event, 'EMBED')">UMAP/tSNE</button>
      <button class="tablinks" onclick="selFun(event, 'DOT')">Dot Plot</button>
      <button class="tablinks" onclick="selFun(event, 'TRAK')">Tracksplot</button>
      <button class="tablinks" onclick="selFun(event, 'DUAL')">Dual Genes</button>
      <button class="tablinks" onclick="selFun(event, 'GD')">Gene Detected</button>
      <button class="tablinks" onclick="selFun(event, 'DEG')">DEG</button>
      <button class="tablinks" onclick="selFun(event, 'MARK')">Marker Genes</button>
      <hr size="1" noshade>
      <button class="tablinks" onclick="selFun(event, 'IMG')">Figure Option</button>
      <button class="tablinks" onclick="selFun(event, 'ABBR')">Comb. & Abbr.</button>
      <button class="tablinks" onclick="save()">Save Session</button>
      <button class="tablinks" onclick="inputClick()">Load Session</button>
      <button class="tablinks" onclick="sync();">Sync <i class="fa fa-refresh"></i></button>
    </div>
	</div>
	<div id="separator" ></div>
	<div id="panel-right" >
    	  
    <input id="loadfile" type="file" onchange="load()" style="display:none"/>
    <div id="ABBR" class="tabcontent"> <!-- Abbreviation -->
      <h3>Combining annotations</h3>
      <label>Create a customized annotation category by combining multiple annotations.</label> 
      <ol type="1">
        <li>Use the following button to uncheck all annotations from the main page, and then a new annotation category will be created by permuting all possible combinations from checked annotations.</li>
        <button onclick="ABBRclear()">Uncheck All Features</button>
        <li>After check the annotations of interest, use the 'Create' button to list the newly created category.</li>
        <button onclick="ABBRcombine()">Create</button>
        <li>Return back to original cell selection mode, please check all annotations</li>
        <button onclick="ABBRall()">Check All Features</button>
      </ol>
      <label>The new annotation named "Custom_combine" includes the folioing annotations:</label>
      <p id="ABBRcombine"></p>
    
      <h3>Abbreviation for cell annotations</h3><!-- <button onclick="ABBRsave()">Save to local</button><input id="ABBRfile" type="file" value="Load from local" onchange="ABBRload()"/>-->
      <p>Choose annotations:</p>
      <p id="ABBRgrp"></p>
      <p id="ABBRtable"></p>
    </div><!--ABBR-->
    
    <div id="ADDG" class="tabcontent">
      <h3>Add genes of interest for plotting</h3>
      <p>Please input a list of genes (comma, semicolon, space or tab delimited):</p>
      <p><textarea id="ADDGinput" rows="5" cols="70"></textarea></p>
      <p><button onclick="ADDGadd()"><b>Add</b></button></p>
      <p>The following genes were added: <span id="ADDGsel"></span></p>
      <p>The following genes are not in the data: <span id="ADDGdel" style="color:red"></span></p>
      
      <h3>Add gene sets of interest for plotting</h3>
      <p>Gene set name: <input id="ADDGsetName" type="text" size=10/>
        Gene names:<input id="ADDGsetGene" type="text" size=35/>
        <button onclick="ADDGsetAdd()"><b>Add</b></button>
      </p>
      <span id="ADDGsetError" style="color:red"></span><br>
      The user-defined gene sets:
      <p id="ADDGsets"></p>
    </div><!--ADDG-->
    
    <div id="GD" class=tabcontent>
      <h3>Genes detected in selected cells </h3>
      <p>In group 1 (<span id="GDcellN1" style="color:red;">0</span>) cells and group 2 (<span id="GDcellN2" style="color:red;">0</span>) cells</p>
      <p>Expression threshold:
      <input id="GDcutoff" type="number" step="0.1" value="1"/></p>
      <p><button class="GDbt" onclick="GDplot()"><b>Plot</b></button></p>
      <p id="GDnote" style="color:red;"></p>
      <div id="GDspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div style="text-align: center;">
        <button onclick="ZoomIn('GDresize')">Zoom In</button>
        <button onclick="ZoomOut('GDresize')">Zoom Out</button>
        <button class="GDpngBT" onclick="saveImg('GDimg')" disabled>Save</button>
      </div>
      <div id="GDresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6">
        <p id="GDfig"></p></div>
    </div><!--GD-->
    
    <div id="MARK" class="tabcontent">
      <h3>Marker genes of annotation categories in selected cells</h3>
      <p>Choose cell set(s):
        <label><input class="MARKcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="MARKcellN1" style="color:red">0</span>)</label>
        <label><input class="MARKcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="MARKcellN2" style="color:red">0</span>)</label>
      </p>
      <p>Select an annotation: 
      <select id="MARKgrp"></select></p>
      <p>By method: 
      <select id="MARKmethod">
        <option value="logreg">logreg</option>
        <option value="t-test">t-test</option>
        <option value="wilcoxon">wilcoxon</option>
        <option value="t-test_overestim_var">t-test_overestim_var</option>
      </select> with the number of genes per group: <input id="MARKn" type="number" step="1" value="10" min="3"/></p>
      <button class="MARKbt" onclick="MARKplot()"><b>Find/Plot</b></button>
      <p id="MARKnote" style="color:red;"></p>
      <div id="MARKspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      
      <table id="MARKtable" class="display"></table>
      <div style="text-align: center;">
        <button onclick="ZoomIn('MARKresize')">Zoom In</button>
        <button onclick="ZoomOut('MARKresize')">Zoom Out</button>
        <button class="MARKpngBT" onclick="saveImg('MARKimg')" disabled>Save</button>
      </div>
      <div id="MARKresize" style="height: 'auto'">
        <p id="MARKfig"></p>
      </div>
    </div><!--MARK-->
    
    <div id="SGV" class="tabcontent">
      <h3>Violin plot of a gene on selected cells</h3>
      <p>Choose cell set(s):
        <label><input class="SGVcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="SGVcellN1" style="color:red">0</span>)</label>
        <label><input class="SGVcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="SGVcellN2" style="color:red">0</span>)</label>
      </p>
      <p>Choose a gene:
      <select id="SGVgene"></select> with expression cutoff: <input id="SGVcutoff" type="number" step="0.1" value="1"/></p>
      <p>Group by:
      <select id="SGVgrp"></select></p>
      <button class="SGVbt" onclick="SGVplot()"><b>Plot</b></button>
      <p id="SGVnote" style="color:red;"></p>
      <div id="SGVspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div style="text-align: center;">
        <button onclick="ZoomIn('SGVresize')">Zoom In</button>
        <button onclick="ZoomOut('SGVresize')">Zoom Out</button>
        <button class="SGVpngBT" onclick="saveImg('SGVimg')" disabled>Save</button>
      </div>
      <div id="SGVresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="SGVfig"></p></div>
    </div><!--SGV-->
    
    <div id="PGV" class="tabcontent">
      <h3>Stacked violin plot of genes on selected cells</h3>
      <p>Choose cell set(s):
        <label><input class="PGVcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="PGVcellN1" style="color:red">0</span>)</label>
        <label><input class="PGVcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="PGVcellN2" style="color:red">0</span>)</label>
      </p>
      <p>Choose genes: with expression cutoff: <input id="PGVcutoff" type="number" step="0.1" value="1"/></p>
      <p id="PGVgene"></p>
      <p>Group by:
      <select id="PGVgrp"></select> as
      <select id="PGVgrpXY">
        <option value="Rows">Rows</option>
        <option value="Columns">Columns</option>
      </select>
      </p>
      <p><button class="PGVbt"  onclick="PGVplot()"><b>Plot</b></button></p>
      <p id="PGVnote" style="color:red;"></p>
      <div id="PGVspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div style="text-align: center;">
        <button onclick="ZoomIn('PGVresize')">Zoom In</button>
        <button onclick="ZoomOut('PGVresize')">Zoom Out</button>
        <button class="PGVpngBT" onclick="saveImg('PGVimg')" disabled>Save</button>
      </div>
      <div id="PGVresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="PGVfig"></p></div>
    </div><!--PGV-->
    
    <div id="HEAT" class="tabcontent">
      <h3>Heatmap on selected cells and genes</h3>
      <p>Choose cell set(s):
        <label><input class="HEATcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="HEATcellN1" style="color:red">0</span>)</label>
        <label><input class="HEATcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="HEATcellN2" style="color:red">0</span>)</label>
      </p>
      <p>Choose genes:</p>
      <p id="HEATgene"></p>
      <p>Clustering by:
      <select id="HEATorder"></select></p>
      <p>Choose annotation:</p>
      <p id="HEATgrp"></p>
      <p>Select plotting scale:
      <select id="HEATnorm">
        <option value="X">Expression</option>
        <option value="zscore">Expression Z-score</option>
      </select></p>
      <p><button class="HEATbt"  onclick="HEATplot()"><b>Plot</b></button></p>
      <p id="HEATnote" style="color:red;"></p>
      <div id="HEATspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div style="text-align: center;">
        <button onclick="ZoomIn('HEATresize')">Zoom In</button>
        <button onclick="ZoomOut('HEATresize')">Zoom Out</button>
        <button class="HEATpngBT" onclick="saveImg('HEATimg')" disabled>Save</button>
        <button class="HEATsaveBT" onclick="HEATsave()" disabled>Data</button>
      </div>
      <div id="HEATresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="HEATfig"></p></div>
      <div id="HEATdata" style="visibility: hidden;"></div>
    
    </div><!--HEAT-->
    
    <div id="DOT" class="tabcontent">
      <h3>Dot plot shows per group, the fraction of cells expressing a gene (dot size) and the mean expression of the gene in those cell (color scale)</h3>
      <p>Choose cell set(s):
        <label><input class="DOTcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="DOTcellN1" style="color:red">0</span>)</label>
        <label><input class="DOTcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="DOTcellN2" style="color:red">0</span>)</label>
      </p>
      <p>Select user-defined gene sets:</p><p id="DOTgeneGrp"></p>
      <p>Group by: <select id="DOTgrp"></select> and the expression cuttoff: <input id="DOTcutoff" type="number" step="0.1" value="1"/></p>
      <p id="DOTerror" style="color:red;"></p>
      <p><button onclick="DOTplot()"><b>Plot</b></button></p>
      <div id="DOTspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div style="text-align: center;">
        <button onclick="ZoomIn('DOTresize')">Zoom In</button>
        <button onclick="ZoomOut('DOTresize')">Zoom Out</button>
        <button class="DOTpngBT" onclick="saveImg('DOTimg')" disabled>Save</button>
      </div>
      <div id="DOTresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="DOTfig"></p></div>
    
    </div><!--DOT-->
    
    <div id="EMBED" class="tabcontent">
      <h3>Embedding plots on selected genes and annotations</h3>
      <p>Choose cell set(s):
        <label><input class="EMBEDcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="EMBEDcellN1" style="color:red">0</span>)</label>
        <label><input class="EMBEDcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="EMBEDcellN2" style="color:red">0</span>)</label>
      </p>
      <p>Choose genes:</p>
      <p id="EMBEDgene"></p>
      <p>Choose annotation groups:</p>
      <p id="EMBEDgrp"></p>
      <p>Select the embedding layout:
      <select id="EMBEDlayout">
        <option value="umap">UMAP</option>
        <option value="tsne">tSNE</option>
      </select> the number of plots per row:
      <input id="EMBEDslot" type="number" value="4" min="2"/>
      </p>
      
      <p><button class="EMBEDbt"  onclick="EMBEDplot()"><b>Plot</b></button></p>
      <p id="EMBEDnote" style="color:red;"></p>
      <div id="EMBEDspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div style="text-align: center;">
        <button onclick="ZoomIn('EMBEDresize')">Zoom In</button>
        <button onclick="ZoomOut('EMBEDresize')">Zoom Out</button>
        <button class="EMBEDpngBT" onclick="saveImg('EMBEDimg')" disabled>Save</button>
      </div>
      <div id="EMBEDresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="EMBEDfig"></p></div>
    
    </div><!--EMBED-->
    
    <div  id="TRAK" class="tabcontent">
      <h3>Track plot shows the gene expression represented by height</h3>
      <p>Choose cell set(s):
        <label><input class="TRAKcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="TRAKcellN1" style="color:red">0</span>)</label>
        <label><input class="TRAKcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="TRAKcellN2" style="color:red">0</span>)</label>
      </p>
      <p>Select user-defined gene sets: </p><p id="TRAKgeneGrp"></p>
      <p>Group by: <select id="TRAKgrp"></select></p>
      <p id="TRAKerror" style="color:red;"></p>
      <p><button onclick="TRAKplot()"><b>Plot</b></button></p>
      <div id="TRAKspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div style="text-align: center;">
        <button onclick="ZoomIn('TRAKresize')">Zoom In</button>
        <button onclick="ZoomOut('TRAKresize')">Zoom Out</button>
        <button class="TRAKpngBT" onclick="saveImg('TRAKimg')" disabled>Save</button>
      </div>
      <div id="TRAKresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="TRAKfig"></p></div>
    
    </div><!--TRAK-->
      
    <div  id="DUAL" class="tabcontent">
      <h3>Embedding plot of two genes in selected cells</h3>
      <p>Choose cell set(s):
        <label><input class="DUALcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="DUALcellN1" style="color:red">0</span>)</label>
        <label><input class="DUALcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="DUALcellN2" style="color:red">0</span>)</label>
      </p>
      <p>Choose two genes:</p>
      <p id="DUALgene"></p>
      <p>Please specify the gene expression cutoff: <input id="DUALcutoff" type="number" step="0.1" value="1"/></p>
      <p>Select the embedding layout:
      <select id="DUALlayout">
        <option value="umap">UMAP</option>
        <option value="tsne">tSNE</option>
      </select>
      </p>
      
      <p><button class="DUALbt"  onclick="DUALplot()"><b>Plot</b></button></p>
      <p id="DUALnote" style="color:red;"></p>
      <div id="DUALspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div style="text-align: center;">
        <button onclick="ZoomIn('DUALresize')">Zoom In</button>
        <button onclick="ZoomOut('DUALresize')">Zoom Out</button>
        <button class="DUALpngBT" onclick="saveImg('DUALimg')" disabled>Save</button>
      </div>
      <div id="DUALresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="DUALfig"></p></div>
      
    </div><!--DUAL-->
    
    <div id="DEG" class="tabcontent">
      <h3>Find differentially expressed genes</h3>
      <p>Between group 1 (<span id="DEGcellN1" style="color:red;">0</span>) cells and group 2 (<span id="DEGcellN2" style="color:red;">0</span>) cells</p>
      <p>Select the number of top DEG: 
      <select id="DEGtop">
        <option value=100>100</option>
        <option value=500>500</option>
        <option value=1000>1000</option>
        <option value=2000>2000</option>
        <option value=5000>5000</option>
      </select></p>
      <p>Select the method: 
      <select id="DEGmethod">
        <option value='t-test'>Welch’s t-test</option>
        <option value='rank'>Wilcoxon rank sum</option>
        <option value='wald'>Wald test</option>
      </select></p>
      
      <p><button class="DEGbt" onclick="DEGfind()"><b>Find</b></button></p>
      <p id="DEGnote" style="color:red;"></p>
      <div id="DEGspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="DEGresize" style="height: 'auto'">
        <table id="DEGtable" class="display"></table>
      </div>
    </div><!--DEG-->
    
    <div id="IMG" class="tabcontent">
      <p>
      <p>Choose a DPI: 
      <select id="IMGdpi" onchange="IMGset()">
        <option value=150>150</option>
        <option value=300>300</option>
        <option value=600>600</option>
      </select></p>
      <p>Choose a figure format: 
      <select id="IMGimg" onchange="IMGset()">
        <option value='png'>PNG</option>
        <option value='svg'>SVG</option>
      </select></p>
      <p>Choose a font size:
      <input id="IMGfontsize" type="number" step="1" value="11" min="5" onchange="IMGset()"/></p>  
      <p>Choose vector friendly:
      <select id="IMGvector" onchange="IMGset()">
        <option value='true'>True</option>
        <option value='false'>False</option>
      </select></p>  
      <p>Choose transparent:
      <select id="IMGtransparent" onchange="IMGset()">
        <option value='true'>True</option>
        <option value='false'>False</option>
      </select></p>  
      <p>Choose UMAP/tSNE color map:
      <select id="IMGcolor" onchange="IMGset()">
        <option value='viridis'>viridis</option>
        <option value='plasma'>plasma</option>
        <option value='inferno'>inferno</option>
        <option value='magma'>magma</option>
        <option value='spring'>spring</option>
        <option value='summer'>summer</option>
        <option value='autumn'>Fall</option>
        <option value='winter'>winter</option>
      </select></p>  
      <table border=0>
        <tr><td>viridis</td><td rowspan=8><img src="static/color_map.png" height="180px"></tr>
        <tr><td>plasma</td></tr>
        <tr><td>inferno</td></tr>
        <tr><td>magma</td></tr>
        <tr><td>spring</td></tr>
        <tr><td>summer</td></tr>
        <tr><td>Fall</td></tr>
        <tr><td>winter</td></tr>
      </table>

    </div><!--IMG-->
	  
	</div>
</div>

<!-- <button class="block" onclick="sync()">Refresh</button> -->



<script type="text/javascript">
var heatCell = 10000;
function checkLoading(){
    if(!window.store || !window.store.getState().categoricalSelection){
      return false;
    }
    var cateN = 0;
    for(const one of window.store.getState().universe.schema.annotations.obs.columns){
      if(one.type=='categorical'){
        cateN++;
      }
    }
    if(cateN!=Object.keys(window.store.getState().categoricalSelection).length){
      return false;
    }
    return true;
}
function enableButton(){
    if(!checkLoading()){
      for(const one of document.getElementsByClassName('tablinks')){
        one.disabled=true;
      }
      setTimeout(enableButton, 100);
    }else{
      for(const one of document.getElementsByClassName('tablinks')){
        one.disabled=false;
      }
      init();
    }
}
enableButton();

function dragElement( element, direction){
    var   md; // remember mouse down info
    const pLeft  = document.getElementById("panel-left");
    const pRight = document.getElementById("panel-right");
    
    element.onmousedown = onMouseDown;
    
    function onMouseDown( e )
    {
    	//console.log("mouse down: " + e.clientX);
    	md = {e,
    	      panelW:pLeft.parentElement.offsetWidth,
    	      lper:parseInt(pLeft.style.width)
    	};
      document.onmousemove = onMouseMove;
      document.onmouseup = () => { 
          document.onmousemove = document.onmouseup = null;
      }
      console.log(md);
    }
    
    function onMouseMove( e )
    {
      var moveR = Math.ceil(100*(e.clientX - md.e.x)/md.panelW);
    	if (direction === "H" ) // Horizontal
    	{
    	    // prevent negative-sized elements
    	    moveR = (moveR < -md.lper) ? 0 : (moveR > (99-md.lper)) ? 0 : moveR;

          element.style.left = md.lper+moveR+"%";
          pLeft.style.width = md.lper+moveR+"%";
          pRight.style.width = (100-(md.lper+moveR)) +"%";
    	}
    }
}
dragElement( document.getElementById("separator"), "H" );

function selFun(evt,sel){
  var i, tabC, tabL;
  tabC = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabC.length; i++) {
    tabC[i].style.display = "none";
  }
  tabL = document.getElementsByClassName("tablinks");
  for (i = 0; i < tabL.length; i++) {
    tabL[i].className = tabL[i].className.replace(" active", "");
  }
  document.getElementById(sel).style.display = "block";
  evt.currentTarget.className += " active";
  sync();
}
function ZoomIn(strDiv){
  var r = $("#"+strDiv).width() / $("#"+strDiv).parent().width() * 100;
  r += 5;
  $("#"+strDiv).width(r+'%');//Math.min(95,r)
}
function ZoomOut(strDiv){
  var r = $("#"+strDiv).width() / $("#"+strDiv).parent().width() * 100;
  r -= 5;
  $("#"+strDiv).width(Math.max(10,r)+'%');
}
function showImg(eID,data){
  document.getElementById(eID).innerHTML = '<img id="'+eID.replace('fig','img')+'" src="data:image/'+window.figOpt['img'].replace('svg','svg+xml')+';base64,'+data+'" width=100% height="auto"/>';
}
function saveImg(pngID){
  var gh = document.getElementById(pngID).src;
  var a = document.createElement('a');
  a.href = gh;
  a.download = pngID+"."+window.figOpt['img'];
  a.target="_blank";
  a.click();
}
function cellNupdate(){
  var n1=0,n2=0;
  if(!!window.store.getState().differential.celllist1){
    n1 = window.store.getState().differential.celllist1.length;
  }
  if(!!window.store.getState().differential.celllist2){
    n2 = window.store.getState().differential.celllist2.length;
  }
  $('#MARKcellN1').text(n1);
  $('#SGVcellN1').text(n1);
  $('#PGVcellN1').text(n1);
  $('#HEATcellN1').text(n1);
  $('#DOTcellN1').text(n1);
  $('#DEGcellN1').text(n1);
  $('#GDcellN1').text(n1);
  $('#EMBEDcellN1').text(n1);
  $('#TRAKcellN1').text(n1);
  $('#DUALcellN1').text(n1);

  $('#MARKcellN2').text(n2);
  $('#SGVcellN2').text(n2);
  $('#PGVcellN2').text(n2);
  $('#HEATcellN2').text(n2);
  $('#DEGcellN2').text(n2);
  $('#DOTcellN2').text(n2);
  $('#GDcellN2').text(n2);
  $('#EMBEDcellN2').text(n2);
  $('#TRAKcellN2').text(n2);
  $('#DUALcellN2').text(n2);
}

//Page Initial functions
function createOpt(val){
  var opt = document.createElement("option");
  opt.text = val;
  opt.value = val;
  return(opt)
}
function init(){
  if(!('bioInit' in window)){
    //----------------
    $("#panel-left").prop('style')['width'] = "20%";
    $("#separator").prop('style')['left'] = "20%";
    $("#panel-right").prop('style')['width'] = "80%";
    //--------------------------------------------------------------------------
    //ABBRinit
    var grps = Object.keys(window.store.getState().categoricalSelection);
    var grpL = window.store.getState().categoricalSelection;
    var htmlCheck= "";
    for(i=0;i<grps.length;i++){
      htmlCheck += '<label><input class="ABBRgrps" type="checkbox" value="'+grps[i]+'" onclick="ABBRlist()"/> '+grps[i]+' ('+grpL[grps[i]].numCategoryValues+')</label>';
    }  
    $('#ABBRgrp').html(htmlCheck);
    
    var bioAbbr = {}
    for(i=0;i<grps.length;i++){
      var one = {}
      for(var j=0;j<grpL[grps[i]].numCategoryValues;j++){
        one[grpL[grps[i]].categoryValues[j]] = grpL[grps[i]].categoryValues[j].toString();
      }
      bioAbbr[grps[i]] = one;
    }
    window.bioAbbr=bioAbbr;
    window.bioCombine={};
    window.biogen=[];
    window.bioGeneGrp={};
    window.figOpt={dpi:150,img:'png',fontsize:11,vectorFriendly:'true',transparent:'false',colorMap:'viridis'};
    //--------------------------------------------------------------------------
    //SGV & PGV annotation categories
    var sgv = document.getElementById("SGVgrp");
    var pgv = document.getElementById("PGVgrp");
    var heat = document.getElementById("HEATorder");
    var dot = document.getElementById("DOTgrp");
    var trak = document.getElementById("TRAKgrp");
    var mark = document.getElementById("MARKgrp");
    for(const one of grps){
      sgv.add(createOpt(one));
      pgv.add(createOpt(one));
      heat.add(createOpt(one));
      dot.add(createOpt(one));
      trak.add(createOpt(one));
      mark.add(createOpt(one));
    }
    //--------------------------------------------------------------------------
    //HEAT
    htmlCheck= "";
    for(const one of grps){
      htmlCheck += '<label><input class="HEATgrps" type="checkbox" value="'+one+'"/> '+one+' ('+grpL[one].numCategoryValues+')</label>';
    }  
    $('#HEATgrp').html(htmlCheck);
    //--------------------------------------------------------------------------
    //EMBED
    htmlCheck= "";
    for(const one of grps){
      htmlCheck += '<label><input class="EMBEDgrps" type="checkbox" value="'+one+'"/> '+one+' ('+grpL[one].numCategoryValues+')</label>';
    }  
    $('#EMBEDgrp').html(htmlCheck);
    //obtain the minimal expression value
    /*
    $.ajax({
      type:"POST",
      url: "/VIP",
      data:JSON.stringify({'method':"MINX"}),
      contentType: 'application/json;charset=UTF-8',//
      success: function(res){
        $('#GDcutoff').prop('min',res);
        $('#DUALcutoff').prop('min',res);
        $('#DOTcutoff').prop('min',res);
      }
    })*/
    $('#SGVcutoff').prop('min',0);
    $('#PGVcutoff').prop('min',0);  
    $('#GDcutoff').prop('min',0);
    $('#DUALcutoff').prop('min',0);
    $('#DOTcutoff').prop('min',0);  

    const unsubscribe = window.store.subscribe(() => {
      sync();
    });
    
    window.bioInit=true;
  }
  return true;
}
//Page sync functions
function sync(){
  cellNupdate();
  ABBRref();
  ADDGref();
  GDref();
  SGVref();
  PGVref();
  HEATref();
  DOTref();
  TRAKref();
  DUALref();
  DEGref();
  EMBEDref();
  IMGref();
}
function ABBRref(){
}
function ADDGref(){
  var genes =  window.biogen;
  $("#ADDGsel").text(genes.join(", "));
  
  var html= "";
  var grpKeys = Object.keys(window.bioGeneGrp);
  for(const one of grpKeys){
    html += "<p><button onclick=\"ADDGsetDel('"+one+"')\"><b>Delete</b></button> <b>"+one+"</b>: " + window.bioGeneGrp[one]+"</p>";
  }
  $("#ADDGsets").html(html);

}
function GDref(){
}
function MARKref(){
  var x = document.getElementById("MARKgrp");
  var grps = Object.keys(window.store.getState().categoricalSelection);
  var grpKeys = Object.keys(window.bioCombine);
  if(grpKeys.length>0 && grps.length==x.length){
    var opt = document.createElement("option");
    opt.text = "Custom_combine";
    opt.value = "Custom_combine";
    x.add(opt);
  }else if(grpKeys.length==0 && grps.length<x.length){
    x.remove(grps.length);
  }
}
function SGVref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  optG = [];
  var i,x = document.getElementById("SGVgene");
  //remove options which are not in the gene list
  $("#SGVgene option").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      x.remove($(this).index())
    }
  });
  //add options which are missing from gene list
  if(genes.length>0){
    for(const g of genes){
      if(!optG.includes(g)){
        x.add(createOpt(g));
      }
    }
  }
  
  var x = document.getElementById("SGVgrp");
  var grps = Object.keys(window.store.getState().categoricalSelection);
  var grpKeys = Object.keys(window.bioCombine);
  if(grpKeys.length>0 && grps.length==x.length){
    var opt = document.createElement("option");
    opt.text = "Custom_combine";
    opt.value = "Custom_combine";
    x.add(opt);
  }else if(grpKeys.length==0 && grps.length<x.length){
    x.remove(grps.length);
  }
}
function PGVref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  var optG = [], NcheckG=[];
  //remove checkbox which are not in the gene list
  $(".PGVgenes").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      $('#PGVck'+$(this).val()).remove();
    }else if($(this).prop("checked") == false){
      NcheckG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(genes.length>0){
    var htmlCheck = $('#PGVgene').html();
    for(const g of genes){
      if(!optG.includes(g)){
        htmlCheck += '<label id="PGVck'+g+'"><input class="PGVgenes" type="checkbox" value="'+g+'" checked/>'+g+'</label>';// '+g+'
      }
    }
    $('#PGVgene').html(htmlCheck);
  }
  $(".PGVgenes").each(function(){
    if(NcheckG.includes($(this).val())){
      $(this).prop("checked",false);
    }
  })

  var x = document.getElementById("PGVgrp");
  var grps = Object.keys(window.store.getState().categoricalSelection);
  var grpKeys = Object.keys(window.bioCombine);
  if(grpKeys.length>0 && grps.length==x.length){
    x.add(createOpt("Custom_combine"));
  }else if(grpKeys.length==0 && grps.length<x.length){
    x.remove(grps.length);
  }


}
function HEATref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  var optG = [], NcheckG=[];
  //remove checkbox which are not in the gene list
  $(".HEATgenes").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      $('#HEATck'+$(this).val()).remove();
    }else if($(this).prop("checked") == false){
      NcheckG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(genes.length>0){
    var htmlCheck = $('#HEATgene').html();
    for(const g of genes){
      if(!optG.includes(g)){
        htmlCheck += '<label id="HEATck'+g+'"><input class="HEATgenes" type="checkbox" value="'+g+'" checked/>'+g+'</label>';//
      }
    }
    $('#HEATgene').html(htmlCheck);
  }
  $(".HEATgenes").each(function(){
    if(NcheckG.includes($(this).val())){
      $(this).prop("checked",false);
    }
  })

  var nCells = 0;
  var x = document.getElementsByClassName('HEATcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked && !!window.store.getState().differential[x[i].value]){
      nCells += window.store.getState().differential[x[i].value].length;
    }
  }
  var grps = Object.keys(window.store.getState().categoricalSelection); 
  x = document.getElementById("HEATorder");
  if(nCells<heatCell && grps.length==x.length){
    x.add(createOpt("Expression"));
  }else if(nCells>heatCell && grps.length<x.length){
    x.remove(grps.length);
  }
}
function DOTref(){
  var gSets = Object.keys(window.bioGeneGrp);
  var optG = [], NcheckG=[];
  //remove checkbox which are not in the gene list
  $(".DOTsets").each(function(){
    optG.push($(this).val());
    if(!gSets.includes($(this).val())){
      $('#DOTck'+$(this).val()).remove();
    }else if($(this).prop("checked") == false){
      NcheckG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(gSets.length>0){
    var htmlCheck = $('#DOTgeneGrp').html();
    for(const g of gSets){
      if(!optG.includes(g)){
        htmlCheck += '<label id="DOTck'+g+'"><input class="DOTsets" type="checkbox" value="'+g+'" checked/>'+g+'</label>';// '+g+'
      }
    }
    $('#DOTgeneGrp').html(htmlCheck);
  }
  $(".DOTsets").each(function(){
    if(NcheckG.includes($(this).val())){
      $(this).prop("checked",false);
    }
  })

  
  var x = document.getElementById("DOTgrp");
  var grps = Object.keys(window.store.getState().categoricalSelection);
  var grpKeys = Object.keys(window.bioCombine);
  if(grpKeys.length>0 && grps.length==x.length){
    x.add(createOpt("Custom_combine"));
  }else if(grpKeys.length==0 && grps.length<x.length){
    x.remove(grps.length);
  }
}
function TRAKref(){
  var gSets = Object.keys(window.bioGeneGrp);
  var optG = [], NcheckG=[];
  //remove checkbox which are not in the gene list
  $(".TRAKsets").each(function(){
    optG.push($(this).val());
    if(!gSets.includes($(this).val())){
      $('#TRAKck'+$(this).val()).remove();
    }else if($(this).prop("checked") == false){
      NcheckG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(gSets.length>0){
    var htmlCheck = $('#TRAKgeneGrp').html();
    for(const g of gSets){
      if(!optG.includes(g)){
        htmlCheck += '<label id="TRAKck'+g+'"><input class="TRAKsets" type="checkbox" value="'+g+'" checked/>'+g+'</label>';// '+g+'
      }
    }
    $('#TRAKgeneGrp').html(htmlCheck);
  }
  $(".TRAKsets").each(function(){
    if(NcheckG.includes($(this).val())){
      $(this).prop("checked",false);
    }
  })
  
  var x = document.getElementById("TRAKgrp");
  var grps = Object.keys(window.store.getState().categoricalSelection);
  var grpKeys = Object.keys(window.bioCombine);
  if(grpKeys.length>0 && grps.length==x.length){
    x.add(createOpt("Custom_combine"));
  }else if(grpKeys.length==0 && grps.length<x.length){
    x.remove(grps.length);
  }

}
function EMBEDref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  var optG = [], NcheckG=[];
  //remove checkbox which are not in the gene list
  $(".EMBEDgenes").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      $('#EMBEDck'+$(this).val()).remove();
    }else if($(this).prop("checked") == false){
      NcheckG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(genes.length>0){
    var htmlCheck = $('#EMBEDgene').html();
    for(const g of genes){
      if(!optG.includes(g)){
        htmlCheck += '<label id="EMBEDck'+g+'"><input class="EMBEDgenes" type="checkbox" value="'+g+'" checked/>'+g+'</label>';// '+g+'
      }
    }
    $('#EMBEDgene').html(htmlCheck);
  }
  $(".EMBEDgenes").each(function(){
    if(NcheckG.includes($(this).val())){
      $(this).prop("checked",false);
    }
  })
}
function DUALref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  var optG = [], checkG=[];
  //remove checkbox which are not in the gene list
  $(".DUALgenes").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      $('#DUALck'+$(this).val()).remove();
    }else if($(this).prop("checked")){
      checkG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(genes.length>0){
    var htmlCheck = $('#DUALgene').html();
    for(const g of genes){
      if(!optG.includes(g)){
        htmlCheck += '<label id="DUALck'+g+'"><input class="DUALgenes" type="checkbox" value="'+g+'" onclick="DUALref()"/>'+g+'</label>';// '+g+'
      }
    }
    $('#DUALgene').html(htmlCheck);
  }
  var iEnabled=0;
  $(".DUALgenes").each(function(){
    if(checkG.includes($(this).val())){
      $(this).prop("checked",true);
      iEnabled++;
    }
  })
  if(iEnabled>1){
    $(".DUALgenes").each(function(){
      if($(this).prop("checked")==false){
        $(this).prop("disabled",true);
      }
    })
  }else{
    $('.DUALgenes').prop("disabled",false);
  }
  
}
function DEGref(){

}
function IMGref(){
  $('#IMGdpi').val(window.figOpt['dpi']);
  $('#IMGimg').val(window.figOpt['img']);
  $('#IMGfontsize').val(window.figOpt['fontsize']);
  $('#IMGvector').val(window.figOpt['vectorFriendly']);
  $('#IMGtransparent').val(window.figOpt['transparent']);
  $('#IMGcolor').val(window.figOpt['colorMap']);
}
// process annotation
function ABBRlist(){
  var grps = {},nrows=0,i;
  var x = document.getElementsByClassName('ABBRgrps');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      grps[x[i].value]=window.store.getState().categoricalSelection[x[i].value].categoryValues.map(String);
      nrows = Math.max(nrows,grps[x[i].value].length);
    }
  }
  var grpKey = Object.keys(grps);
  var htmlTable = "<table style='width:100%;border-collapse: collapse;'><tr>";
  for(i=0;i<grpKey.length;i++){
    htmlTable += "<th colspan='2' style='background-color: #4CAF50;color: white;'>"+grpKey[i]+"</th>"
  }
  htmlTable += "</tr><tr>";
  for(i=0;i<nrows;i++){
    for(var j=0;j<grpKey.length;j++){
      if(j>0){
        htmlTable += "<td align='right' style='border-left:2px solid #888'>"
      }else{
        htmlTable += "<td align='right'>"
      }
      if(i<grps[grpKey[j]].length){//grpKey[j]+"','"+grps[grpKey[j]][i]
        htmlTable += grps[grpKey[j]][i]+'</td><td><input type="text" id="'+grpKey[j]+"|"+grps[grpKey[j]][i]+'" value="' +window.bioAbbr[grpKey[j]][grps[grpKey[j]][i]]+'" onchange=ABBRupdate(["'+grpKey[j].replace(/ /g,";;")+'","'+grps[grpKey[j]][i].replace(/ /g,";;")+'"])></td>';
      }else{
        htmlTable += "</td><td></td>";
      }
    }
    htmlTable += "</tr><tr>"
  }
  htmlTable += "</tr></table>"
  $('#ABBRtable').html(htmlTable);
}
function ABBRupdate(eID){
  for(var i=0;i<eID.length;i++){
    eID[i] = eID[i].replace(/;;/g," ");
  }
  window.bioAbbr[eID[0]][eID[1]] = $('#'+eID.join("\\|").replace(/ /g,"\\ ")).val();
}
function ABBRclear(){
  var grpKeys = Object.keys(window.store.getState().categoricalSelection);
  for(var i=0;i<grpKeys.length;i++) {
    window.store.dispatch({type: "categorical metadata filter none of these", metadataField: grpKeys[i]});
  }
  return;
}
function ABBRall(){
  var grpKeys = Object.keys(window.store.getState().categoricalSelection);
  for(var i=0;i<grpKeys.length;i++) {
    window.store.dispatch({type: "categorical metadata filter all of these", metadataField: grpKeys[i]});
  }
  return;
}
function ABBRcombine(){
  window.bioCombine={};
  var combGrp = {};
  var grpKeys = Object.keys(window.store.getState().categoricalSelection);
  for(var i=0;i<grpKeys.length;i++) {
    if(window.store.getState().categoricalSelection[grpKeys[i]].categorySelected){
      combGrp[grpKeys[i]] = window.store.getState().categoricalSelection[grpKeys[i]].categoryValues;
    }else{
      var one = [];
      for(var j=0;j<window.store.getState().categoricalSelection[grpKeys[i]].numCategoryValues;j++){
        if(window.store.getState().categoricalSelection[grpKeys[i]].categoryValueSelected[j]){
          one.push(window.store.getState().categoricalSelection[grpKeys[i]].categoryValues[j]);
        }
      }
      if(one.length>0){
        combGrp[grpKeys[i]] = one;
      }
    }
  }
  grpKeys = Object.keys(combGrp);
  if(grpKeys.length==0||grpKeys.length>5) return
  window.bioCombine=combGrp;
  var combVal = [];
  for(var i=0;i<grpKeys.length;i++){
    if(combVal.length==0){
      for(var j=0;j<combGrp[grpKeys[i]].length;j++){
        combVal.push(window.bioAbbr[grpKeys[i]][combGrp[grpKeys[i]][j]])
      }
    }else{
      newGrp = [];
      for(var k=0;k<combVal.length;k++){
        for(var j=0;j<combGrp[grpKeys[i]].length;j++){
          newGrp.push(combVal[k]+"_"+window.bioAbbr[grpKeys[i]][combGrp[grpKeys[i]][j]])
        }        
      }
      combVal = newGrp;
    }
  }
  $('#ABBRcombine').html("<span style='color:red;'><strong>"+combVal.join('; ')+"</strong></span>");
}
function ABBRcombineUpdate(){
  var combGrp = window.bioCombine;
  var combKey = Object.keys(combGrp);
  var allGrp = window.store.getState().categoricalSelection;
  for(var i=0;i<combKey.length;i++){
    //console.log(allGrp[combKey[i]].categoryValues);
    for(var j=0;j<allGrp[combKey[i]].numCategoryValues;j++){
      if(combGrp[combKey[i]].includes(allGrp[combKey[i]].categoryValues[j])){
        window.store.dispatch({type: "categorical metadata filter select", metadataField: combKey[i], categoryIndex: j});
        //console.log([combKey[i],allGrp[combKey[i]].categoryValues[j]]);
      }
    }
  }
  return;
}
// process genes
//Fxyd3,Lgals7,Acta2,Krt5,Cd79a,Rac2,Coro1a
function ADDGadd(){
  var addG = $("#ADDGinput").val().split(/\s+|\,|\;/);
  var genes =  window.biogen;
  var notG = [];
  var totalG = window.store.getState().universe.varAnnotations.__columns[0];
  var totalGlower = totalG.map(function(s){return s.toLowerCase();});
  
  for(var i=0;i<addG.length;i++){
    var one = addG[i].trim();
    if (addG[i].trim().length<1)
      continue;
    var ix = totalGlower.indexOf(one.toLowerCase());
    if(ix !== -1){
      var oneG = totalG[ix];
      if(!genes.includes(oneG)){
        genes.push(oneG);
      }
    }else{
      notG.push(one);
    }
  }
  $("#ADDGdel").text(notG.join(", "));
  $("#ADDGinput").val("");
  ADDGref();
}
function ADDGsetAdd(){
  $("#ADDGsetError").text("");
  var grpName = $("#ADDGsetName").val().trim();
  if(grpName.length<1){
    $("#ADDGsetError").text("Please provide a gene set name with at least one character!");
    return;
  }
  var grpKeys = Object.keys(window.bioGeneGrp);
  if(grpKeys.includes(grpName)){
    $("#ADDGsetError").text("The gene set name exists!");
    return;
  }
  var definedG = [];
  for(var i=0;i<grpKeys.length;i++){
    definedG = definedG.concat(window.bioGeneGrp[grpKeys[i]]);
  }
  
  var gNames = $("#ADDGsetGene").val().trim().split(/\s+|\,|\;/);
  var notG = [],geneNames=[];
  var totalG = window.store.getState().universe.varAnnotations.__columns[0];
  var totalGlower = totalG.map(function(s){return s.toLowerCase();});
  for(var i=0;i<gNames.length;i++){
    var one = gNames[i].trim();
    var ix = totalGlower.indexOf(one.toLowerCase());
    if(ix !== -1){
      var oneG = totalG[ix];
      if (one.length<1) continue;
      if(!definedG.includes(oneG)){
        geneNames.push(oneG);
      }else{
        notG.push(one);
      }
    }else{
      notG.push(one);
    }
  }
  var eMsg= "";
  if(notG.length>0){
    eMsg +="The following genes cannot be found in the data or defined in previous gene sets: "+notG;
    $("#ADDGsetError").text(eMsg);
  }
  if(geneNames.length==0){
    $("#ADDGsetError").text(eMsg+". No valid gene names is provided");
    return;
  }
  $("#ADDGsetName").val("");
  $("#ADDGsetGene").val("");
  window.bioGeneGrp[grpName] = geneNames;

  geneNames = geneNames.concat(window.biogen);
  geneNames = [...new Set(geneNames)];
  window.biogen = geneNames;
  ADDGref();
}
function ADDGsetDel(grpName){
  delete window.bioGeneGrp[grpName];
  ADDGref();
}
// plot function 
function IMGset(){
  window.figOpt['dpi'] = $('#IMGdpi').val();
  window.figOpt['img'] = $('#IMGimg').val();
  window.figOpt['fontsize'] = Math.max($('#IMGfontsize').val(),$('#IMGfontsize').prop('min'));
  window.figOpt['vectorFriendly'] = $('#IMGvector').val();
  window.figOpt['transparent'] = $('#IMGtransparent').val();
  window.figOpt['colorMap'] = $('#IMGcolor').val();
  IMGref();
}
function GDplot(){
  if(!window.store.getState().differential.celllist1 && !window.store.getState().differential.celllist2){
    $('#GDnote').text("Please select cells into group 1 or/and group 2");
    return;
  }
  var cells = {};
  if(window.store.getState().differential.celllist1){
    cells['group1'] = window.store.getState().differential.celllist1;
  }
  if(window.store.getState().differential.celllist2){
    cells['group2'] = window.store.getState().differential.celllist2;
  }
  if(+$('#GDcutoff').prop('min') > +$("#GDcutoff").val()){
    $('#GDnote').text("The minimal expression level is: "+$('#GDcutoff').prop('min'));
    return;
  }

  var D = {'method':'GD',
            'cells':cells,
            'cutoff':$("#GDcutoff").val(),
            'figOpt':window.figOpt};
  $(".GDbt").prop('disabled',true);
  $(".GDpngBT").prop('disabled',true);
  document.getElementById("GDspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',
    success: function(res){
      showImg('GDfig',res);
      $(".GDbt").prop("disabled",false);
      $(".GDpngBT").prop('disabled',false);
      document.getElementById("GDspin").style.visibility="hidden";
    },
    error: function(request,status,error){
      $('#GDnote').text(request.status+request.responseText);
      document.getElementById("GDfig").innerHTML = '<img id="GDpng" src="data:image/png;base64," width=100% height="auto"/>';
      $(".GDbt").prop("disabled",false);
      document.getElementById("GDspin").style.visibility="hidden";
    }
  });

}
function MARKplot(){
  var cells=[], x = document.getElementsByClassName('MARKcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#MARKnote').text("Please use selection tools to put cells into groups");
    return;
  }
  
  if($("#MARKn").val()<3){
    $('#MARKnote').text("Minimal number of markers per group is 3");
    return;
  }
  var grp = [$("#MARKgrp option:selected").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  
  
  $(".MARKbt").prop("disabled",true);
  $(".MARKpngBT").prop('disabled',true);
  document.getElementById("MARKspin").style.visibility="visible";
  var D = {'method':'MARK',
            'cells':cells,
            'genes':[],
            'grp':grp,
            'markMethod':$("#MARKmethod option:selected").val(),
            'geneN':$("#MARKn").val(),
            'abb':window.bioAbbr,
            'combine':combGrp,
            'figOpt':window.figOpt};
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      resD = JSON.parse(res);
      var tD = resD[0];
      var keyD = tD.shift();
      var titleD = [];
      for(const one of keyD){
        titleD.push({'title':one})
      }
      $('#MARKtable').empty();
      var table = $('#MARKtable').DataTable({
        destroy: true,
        dom:'Blfrtip',
        lengthMenu:[[10,50,100,200,-1],[10,50,100,200,"All"]],
        order:[[1,"dsc"]],
        buttons:['csv'],
        data:tD,
        columns:titleD
      });

      $('#MARKtable tbody').on('click',"tr",function(){
        var data = table.row(this).data();
        //alert('Your clicked on '+data[0]+" row");
        var genes =  window.biogen;
        if(genes.includes(data[0])){
          genes.splice(genes.indexOf(data[0]),1);
        }else{
          genes.push(data[0]);
        }
        $('#MARKnote').text("Selected genes: "+genes.join(", "));
      });
      showImg('MARKfig',resD[1]);
      document.getElementById("MARKspin").style.visibility="hidden";
      $(".MARKbt").prop("disabled",false);
      $(".MARKpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#MARKnote').text(request.status+request.responseText);
      $('#MARKtable').empty();
      document.getElementById("MARKfig").innerHTML = '';
      $(".MARKbt").prop("disabled",false);
      document.getElementById("MARKspin").style.visibility="hidden";
    }
  })

}
function SGVplot(){
  $('#SGVnote').text("");
  if($("#SGVgene option:selected").val()=="NA"){
    $('#SGVnote').text("Please select a gene to plot");
    return;
  }
  if($("#SGVgrp option:selected").val()=="NA"){
    $('#SGVnote').text("Please select a category to plot");
    return;
  }
  var cells=[], x = document.getElementsByClassName('SGVcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if($('#SGVgene').val() == null) {
    $('#SGVnote').text('Please add genes either from the VIP menu or the main window');
    return;
  }
  if(cells.length==0){
    $('#SGVnote').text("Please use selection tools to put cells into groups");
    return;
  }
  if(+$("#SGVcutoff").val() < +$("#SGVcutoff").prop('min')){
    $('#SGVnote').text("The minimal expression level is "+$("#SGVcutoff").prop('min'));
    return;
  }
  //$('#SGVnote').text("Plotting on "+cells.length+" selected cells");
  var grp = [$("#SGVgrp").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
    $('#SGVnote').text("");
  }
  
  var D = {'method':'SGV',
            'cells':cells,
            'genes':[$("#SGVgene").val()],
            'grp':grp,
            'abb':window.bioAbbr,
            'cutoff':$("#SGVcutoff").val(),
            'combine':combGrp,
            'figOpt':window.figOpt};
  $(".SGVbt").prop("disabled",true);
  $(".SGVpngBT").prop('disabled',true);
  document.getElementById("SGVspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      showImg('SGVfig',res);
      //document.getElementById("SGVfig").innerHTML = '<img id="SGVpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".SGVbt").prop("disabled",false);
      $(".SGVpngBT").prop('disabled',false);
      document.getElementById("SGVspin").style.visibility="hidden";
    },
    error: function(request,status,error){
      $('#SGVnote').text(request.status+request.responseText);
      document.getElementById("SGVfig").innerHTML = '<img id="SGVpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".SGVbt").prop("disabled",false);
      document.getElementById("SGVspin").style.visibility="hidden";
    }
  })
}
function PGVplot(){
  $('#PGVnote').text("");
  var genes = [];
  var i, x = document.getElementsByClassName('PGVgenes');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      genes.push(x[i].value);
    }
  }
  if(genes.length==0){
    $('#PGVnote').text("Please select a gene to plot");
    return;
  }
  if($("#PGVgrp option:selected").val()=="NA"){
    $('#PGVnote').text("Please select a category to plot");
    return;
  }
  var cells=[], x = document.getElementsByClassName('PGVcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#PGVnote').text("Please use selection tools to put cells into groups");
    return;
  }
  if(+$("#PGVcutoff").val()< +$("#PGVcutoff").prop('min')){
    $('#PGVnote').text("The minimal expression level is "+$("#PGVcutoff").prop('min'));
    return;
  }

  var grp = [$("#PGVgrp").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  var D = {'method':'PGV',
            'cells':cells,
            'genes':genes,
            'grp':grp,
            'by':$("#PGVgrpXY").val(),
            'abb':window.bioAbbr,
            'cutoff':$("#PGVcutoff").val(),
            'combine':combGrp,
            'figOpt':window.figOpt};
  $(".PGVbt").prop('disabled',true);
  document.getElementById("PGVspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      showImg('PGVfig',res);
      //document.getElementById("PGVfig").innerHTML = '<img id="PGVpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".PGVbt").prop("disabled",false);
      $(".PGVpngBT").prop('disabled',false);
      document.getElementById("PGVspin").style.visibility="hidden";
    },
    error: function(request,status,error){
      $('#PGVnote').text(request.status+request.responseText);
      document.getElementById("PGVfig").innerHTML = '<img id="PGVpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".PGVbt").prop("disabled",false);
      document.getElementById("PGVspin").style.visibility="hidden";

    }
  })
}
function HEATplot(){
  $('#HEATnote').text("");
  var cells=[], x = document.getElementsByClassName('HEATcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }

  if(cells.length==0){
    $('#HEATnote').text("Please use selection tools to put cells into groups");
    return;
  }

  var genes = [];
  var i, x = document.getElementsByClassName('HEATgenes');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      genes.push(x[i].value);
    }
  }
  if(genes.length<2){
    $('#HEATnote').text("It needs at least two genes");
    return;
  }
  var grps = [];
  x = document.getElementsByClassName('HEATgrps');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      grps.push(x[i].value);
    }
  }
  var orderGrp = $("#HEATorder").val();
  if(orderGrp=="Expression" && cells.length>heatCell){
    $('#HEATnote').text("Clustering by expression is not available for the number of selected cells larger than "+Math.round(heatCell/1000)+"k.");
    return;
  }
  if(orderGrp!="Expression" && !grps.includes(orderGrp)){
    grps.push(orderGrp);
  }
  if(grps.length==0){
    $('#HEATnote').text("Please select groups to plot");
    return;
  }
  document.getElementById("HEATspin").style.visibility="visible";
  $(".HEATbt").prop('disabled',true);
  $(".HEATpngBT").prop('disabled',true);
  $(".HEATsaveBT").prop('disabled',true);
  var D = {'method':'HEAT',
            'cells':cells,
            'genes':genes,
            'order':orderGrp,
            'norm':$("#HEATnorm option:selected").val(),
            'grp':grps,
            'figOpt':window.figOpt};
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      resD = JSON.parse(res);
      showImg('HEATfig',resD[0]);
      //document.getElementById("HEATfig").innerHTML = '<img id="HEATpng" src="data:image/png;base64,'+resD[0]+'" width=100% height="auto"/>';// height="450" width="450"
      $("#HEATdata").text(resD[1]);//Cd79a, Fxyd3, Cd74, Cd52, Krt5
      $(".HEATbt").prop("disabled",false);
      $(".HEATpngBT").prop('disabled',false);
      $(".HEATsaveBT").prop('disabled',false);
      document.getElementById("HEATspin").style.visibility="hidden";
    },
    error: function(request,status,error){
      $('#HEATnote').text(request.status+request.responseText);
      document.getElementById("HEATfig").innerHTML = '<img id="HEATpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $("#HEATdata").text('');//Cd79a, Fxyd3, Cd74, Cd52, Krt5
      $(".HEATbt").prop("disabled",false);
      document.getElementById("HEATspin").style.visibility="hidden";

    }
  })

}
function HEATsave(){
  var content = $("#HEATdata").text();
  var hiddenE = document.createElement('a');
  hiddenE.href="data:attachment/text,"+encodeURIComponent(content);
  hiddenE.target='_blank';
  hiddenE.download='cellxgene.'+window.store.getState().config.displayNames.dataset+'.heatmapData.csv';
  hiddenE.click();
}
function DEGfind(){
  var cells = {};
  if(!window.store.getState().differential.celllist1 || !window.store.getState().differential.celllist2){
    $('#DEGnote').text("Please select cells into both group 1 and group 2");
    return;
  }else{
    cells['group1'] = window.store.getState().differential.celllist1;
    cells['group2'] = window.store.getState().differential.celllist2;
  }
  var D = {'method':'DEG',
           'topN':$("#DEGtop").val(),
           'DEmethod':$("#DEGmethod").val(),
           'cells':{"group1":window.store.getState().differential.celllist1,
                    "group2":window.store.getState().differential.celllist2}};
  document.getElementById("DEGspin").style.visibility="visible";
  $(".DEGbt").prop('disabled',true);
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(data){
      $('#DEGtable').empty();
      var table = $('#DEGtable').DataTable({
        destroy: true,
        dom:'Blfrtip',
        lengthMenu:[[10,50,100,200,-1],[10,50,100,200,"All"]],
        order:[[3,"asc"]],
        buttons:['csv'],
        data:JSON.parse(data),
        columns:[
          {title: "Gene"},
          {title: "Log Fold Change"},
          {title: "p-value"},
          {title: "padj"}
        ]
      });
      document.getElementById("DEGspin").style.visibility="hidden";
      $(".DEGbt").prop("disabled",false);
      
      $('#DEGnote').text("");
      $('#DEGtable tbody').on('click',"tr",function(){
        var data = table.row(this).data();
        //alert('Your clicked on '+data[0]+" row");
        var genes =  window.biogen;
        if(genes.includes(data[0])){
          genes.splice(genes.indexOf(data[0]),1);
        }else{
          genes.push(data[0]);
        }
        $('#DEGnote').text("Selected genes: "+genes.join(", "));
      });
    },
    error: function(request,status,error){
      $('#DEGnote').text(request.status+request.responseText);
      $('#DEGtable').empty();
      document.getElementById("DEGspin").style.visibility="hidden";
      $(".DEGbt").prop("disabled",false);
    }
  })
  
}
function DOTplot(){
  $('#DOTerror').text("");
  var cells=[], x = document.getElementsByClassName('HEATcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#DOTerror').text("Please use selection tools to put cells into groups");
    return;
  }

  var grpKeys=[];
  $(".DOTsets").each(function(){
    if($(this).prop("checked")){
      grpKeys.push($(this).val());
    }
  })
  var genes = [],selSets={};
  for(const one of grpKeys){
    genes = genes.concat(window.bioGeneGrp[one]);
    selSets[one]=window.bioGeneGrp[one];
  }
  if(genes.length==0){
    $('#DOTerror').text("Please add gene sets!");
    return;
  }
  if(+$('#DOTcutoff').prop('min') > +$("#DOTcutoff").val()){
    $('#DOTnote').text("The minimal expression level is: "+$('#DOTcutoff').prop('min'));
    return;
  }
  
  var grp = [$("#DOTgrp").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  var D = {'method':'DOT',
            'cells':cells,
            'genes':genes,
            'grp':grp,
            'abb':window.bioAbbr,
            'combine':combGrp,
            'geneGrp':selSets,
            'cutoff':$("#DOTcutoff").val(),
            'figOpt':window.figOpt};
  $(".DOTbt").prop('disabled',true);
  document.getElementById("DOTspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      showImg('DOTfig',res)
      //document.getElementById("DOTfig").innerHTML = '<img id="DOTpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".DOTbt").prop("disabled",false);
      $(".DOTpngBT").prop('disabled',false);
      document.getElementById("DOTspin").style.visibility="hidden";
    },
    error: function(request,status,error){
      $('#DOTnote').text(request.status+request.responseText);
      document.getElementById("DOTfig").innerHTML = '<img id="DOTpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".DOTbt").prop("disabled",false);
      document.getElementById("DOTspin").style.visibility="hidden";
    }
  })
}
function TRAKplot(){
  $('#TRAKerror').text("");
  var cells=[], x = document.getElementsByClassName('TRAKcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#TRAKerror').text("Please use selection tools to put cells into groups");
    return;
  }

  var grpKeys=[];
  $(".TRAKsets").each(function(){
    if($(this).prop("checked")){
      grpKeys.push($(this).val());
    }
  })
  var genes = [],selSets={};
  for(const one of grpKeys){
    genes = genes.concat(window.bioGeneGrp[one]);
    selSets[one]=window.bioGeneGrp[one];
  }
  if(genes.length==0){
    $('#TRAKerror').text("Please add gene sets!");
    return;
  }
  
  var grp = [$("#TRAKgrp").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  var D = {'method':'TRAK',
            'cells':cells,
            'genes':genes,
            'grp':grp,
            'abb':window.bioAbbr,
            'combine':combGrp,
            'geneGrp':selSets,
            'figOpt':window.figOpt};
  $(".TRAKbt").prop('disabled',true);
  document.getElementById("TRAKspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      showImg('TRAKfig',res);
      //document.getElementById("TRAKfig").innerHTML = '<img id="TRAKpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".TRAKbt").prop("disabled",false);
      $(".TRAKpngBT").prop('disabled',false);
      document.getElementById("TRAKspin").style.visibility="hidden";
    },
    error: function(request,status,error){
      $('#TRAKnote').text(request.status+request.responseText);
      document.getElementById("TRAKfig").innerHTML = '<img id="TRAKpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".TRAKbt").prop("disabled",false);
      document.getElementById("TRAKspin").style.visibility="hidden";
    }
  })
  
}
function EMBEDplot(){
  $('#EMBEDnote').text("");
  var cells=[], x = document.getElementsByClassName('EMBEDcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#EMBEDnote').text("Please use selection tools to put cells into groups");
    return;
  }
  
  var genes = [];
  var i, x = document.getElementsByClassName('EMBEDgenes');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      genes.push(x[i].value);
    }
  }
  if(genes.length==0){
    $('#EMBEDnote').text("Please select a gene to plot");
    return;
  }
  
  var grps = [];
  x = document.getElementsByClassName('EMBEDgrps');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      grps.push(x[i].value);
    }
  }
  if(grps.length==0){
    $('#EMBEDnote').text("Please select groups to plot");
    return;
  }
  if($('#EMBEDslot').val()<2){
    $('#EMBEDnote').text("The minimal number of plots per row is 2");
    return;
  }
  document.getElementById("EMBEDspin").style.visibility="visible";
  $(".EMBEDbt").prop('disabled',true);
  $(".EMBEDpngBT").prop('disabled',true);

  var D = {'method':"EMBED",
            'cells':cells,
            'genes':genes,
            'grp':grps,
            'ncol':$('#EMBEDslot').val(),
            'layout':$("#EMBEDlayout").val(),
            'figOpt':window.figOpt};
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      showImg('EMBEDfig',res);
      //document.getElementById("EMBEDfig").innerHTML = '<img id="EMBEDpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".EMBEDbt").prop("disabled",false);
      $(".EMBEDpngBT").prop('disabled',false);
      document.getElementById("EMBEDspin").style.visibility="hidden";
    },
    error: function(request,status,error){
      $('#EMBEDnote').text(request.status+request.responseText);
      document.getElementById("EMBEDfig").innerHTML = '';// height="450" width="450"
      $(".EMBEDbt").prop("disabled",false);
      document.getElementById("EMBEDspin").style.visibility="hidden";
    }
  })

}
function DUALplot(){
  $('#DUALnote').text("");
  var cells=[], x = document.getElementsByClassName('DUALcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#DUALnote').text("Please use selection tools to put cells into groups");
    return;
  }
  
  var genes = [];
  $(".DUALgenes").each(function(){
    if($(this).prop("checked")){
      genes.push($(this).val());
    }
  })
  if(genes.length!=2){
    $('#DUALnote').text("Please select two genes to plot");
    return;
  }
  if(+$('#DUALcutoff').prop('min') > +$("#DUALcutoff").val()){
    $('#DUALnote').text("The minimal expression level is: "+$('#DUALcutoff').prop('min'));
    return;
  }
  
  document.getElementById("DUALspin").style.visibility="visible";
  $(".DUALbt").prop('disabled',true);
  $(".DUALpngBT").prop('disabled',true);

  var D = {'method':"DUAL",
            'cells':cells,
            'genes':genes,
            'grp':[],
            'layout':$("#DUALlayout").val(),
            'cutoff':$("#DUALcutoff").val(),
            'figOpt':window.figOpt};
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      showImg('DUALfig',res);
      //document.getElementById("DUALfig").innerHTML = '<img id="DUALpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".DUALbt").prop("disabled",false);
      $(".DUALpngBT").prop('disabled',false);
      document.getElementById("DUALspin").style.visibility="hidden";
    },
    error: function(request,status,error){
      $('#DUALnote').text(request.status+request.responseText);
      document.getElementById("DUALfig").innerHTML = '';// height="450" width="450"
      $(".DUALbt").prop("disabled",false);
      document.getElementById("DUALspin").style.visibility="hidden";
    }
  })
}
//save and load
function checkSave(eID){
  var notCK = [];
  for(const one of $("."+eID+":checkbox:not(:checked)")){
    notCK.push(one.value);
  }
  return notCK;
}
function checkLoad(eID,notCK){
  for(const one of $("."+eID)){
    if(notCK.includes(one.value)){
      one.checked=false;
    }else{
      one.checked=true;
    }
  }
}
function ABBRsave(){
  return [window.bioAbbr,window.bioCombine,checkSave('ABBRgrps')];
}
function ABBRload(content){
  window.bioAbbr= content[0];
  window.bioCombine = content[1];
  checkLoad("ABBRgrps",content[2]);
  
  ABBRlist();
  ABBRclear();
  ABBRcombineUpdate();
  ABBRcombine();
}
function ADDsave(){
  return [window.biogen,window.bioGeneGrp];
}
function ADDload(content){
  window.biogen = content[0];
  window.bioGeneGrp = content[1];
  sync();
}
function IMGsave(){
  return(window.figOpt);
}
function IMGload(content){
  window.figOpt = content;
}

function GDsave(){
  var cells = {'celllist1':[],'celllist2':[]};
  if(window.store.getState().differential.celllist1){
    cells['celllist1'] = window.store.getState().differential.celllist1;
  }
  if(window.store.getState().differential.celllist2){
    cells['celllist2'] = window.store.getState().differential.celllist2;
  }
  
  if($('#GDcutoff').prop('min')>$("#GDcutoff").val()){
    $('#GDnote').text("The minimal expression level is: "+$('#GDcutoff').prop('min'));
    return;
  }
  return [cells,Math.max($("#GDcutoff").val(),$('#GDcutoff').prop('min'))];
}
function GDload(content){
  cells = content[0];
  var newCells={};
  for(const one in cells){
    var arr=[];
    for(var p in Object.getOwnPropertyNames(cells[one])){
      arr[p]=cells[one][p];
    }
    newCells[one] = new Int32Array(arr);
  }

  for(const one of Object.keys(newCells)){
    if(newCells[one].length>0){
      window.store.getState().differential[one] = newCells[one];
    }else{
      window.store.getState().differential[one] = null;
    }
  }
  $("#GDcutoff").val(content[1]);
  cellNupdate();
}
function MARKsave(){
  return [checkSave('MARKcell'),$("#MARKgrp").val(),$("#MARKmethod").val(),$("#MARKn").val()];
}
function MARKload(content){
  checkLoad('MARKcell',content[0]);
  $("#MARKgrp").val(content[1])
  $("#MARKmethod").val(content[2])
  $("#MARKn").val(content[3])
}
function SGVsave(){
  return [checkSave('SGVcell'),$("#SGVgene").val(),$("#SGVgrp").val(),
          Math.max($("#SGVcutoff").val(),$('#SGVcutoff').prop('min'))];
}
function SGVload(content){
  checkLoad('SGVcell',content[0]);
  $("#SGVgene").val(content[1]);
  $("#SGVgrp").val(content[2]);
  $("#SGVcutoff").val(content[3]);
}
function PGVsave(){
  return [checkSave('PGVcell'),checkSave("PGVgenes"),$("#PGVgrp").val(),$("#PGVgrpXY").val(),
          Math.max($("#PGVcutoff").val(),$('#PGVcutoff').prop('min'))];
}
function PGVload(content){
  checkLoad('PGVcell',content[0]);
  checkLoad('PGVgenes',content[1]);
  $("#PGVgrp").val(content[2]);
  $("#PGVgrpXY").val(content[3]);
  $("#PGVcutoff").val(content[4]);
}
function HEATsave(){
  return [checkSave('HEATcell'),checkSave("HEATgenes"),$("#HEATorder").val(),checkSave("HEATgrps")];
}
function HEATload(content){
  checkLoad('HEATcell',content[0]);
  checkLoad("HEATgenes",content[1]);
  $("#HEATorder").val(content[2]);
  checkLoad("HEATgrps",content[3]);
}
function EMBEDsave(){
  return [checkSave('EMBEDcell'),checkSave("EMBEDgenes"),checkSave("EMBEDgrps"),$("#EMBEDlayout").val(),$('#EMBEDslot').val()];
}
function EMBEDload(content){
  checkLoad('EMBEDcell',content[0]);
  checkLoad("EMBEDgenes",content[1]);
  checkLoad("EMBEDgrps",content[2]);
  $("#EMBEDlayout").val(content[3]);
  $('#EMBEDslot').val(content[4]);
}
function DOTsave(){
  return [checkSave('DOTcell'),checkSave("DOTsets"),$("#DOTgrp").val(),Math.max($("#DOTcutoff").val(),$('#DOTcutoff').prop('min'))];
}
function DOTload(content){
  checkLoad('DOTcell',content[0]);
  checkLoad("DOTsets",content[1]);
  $("#DOTgrp").val(content[2]);
  $("#DOTcutoff").val(content[3]);
}
function TRAKsave(){
  return [checkSave('TRAKcell'),checkSave("TRAKsets"),$("#TRAKgrp").val()];
}
function TRAKload(content){
  checkLoad('TRAKcell',content[0]);
  checkLoad("TRAKsets",content[1]);
  $("#TRAKgrp").val(content[2]);
}
function DUALsave(){
  return [checkSave('DUALcell'),checkSave("DUALgenes"),Math.max($("#DUALcutoff").val(),$('#DUALcutoff').prop('min')),$("#DUALlayout").val()];
}
function DUALload(content){
  checkLoad('DUALcell',content[0]);
  checkLoad("DUALgenes",content[1]);
  $("#DUALcutoff").val(content[2]);
  $("#DUALlayout").val(content[3]);
}
function DEGsave(){
  return [$("#DEGtop").val(),$("#DEGmethod").val()]
}
function DEGload(content){
  $("#DEGtop").val(content[0]);
  $("#DEGmethod").val(content[1]);
}
function save(){
  sync();

  var content = ['cellxgene.'+window.store.getState().config.displayNames.dataset];
  content.push(ABBRsave());
  content.push(ADDsave());
  content.push(GDsave());
  content.push(MARKsave());
  content.push(SGVsave());
  content.push(PGVsave());
  content.push(HEATsave());
  content.push(EMBEDsave());
  content.push(DOTsave());
  content.push(TRAKsave());
  content.push(DUALsave());
  content.push(DEGsave());
  var hiddenE = document.createElement('a');
  hiddenE.href="data:attachment/text,"+encodeURIComponent(JSON.stringify(content));
  hiddenE.target='_blank';
  hiddenE.download='cellxgene.'+window.store.getState().config.displayNames.dataset+'.info.txt';
  hiddenE.click();
}
function inputClick(){
  sync();
  $("#loadfile").trigger('click');
}
function load(){
  var reader = new FileReader();
  reader.onload=function(ev){
    var content = JSON.parse(decodeURIComponent(ev.target.result));
    if(content[0]!='cellxgene.'+window.store.getState().config.displayNames.dataset){
      alert("Saved information is NOT matching with the current data!");
      return;
    }
    var i=1;
    ABBRload(content[i++]);
    ADDload(content[i++]);
    GDload(content[i++]);
    MARKload(content[i++]);
    SGVload(content[i++]);
    PGVload(content[i++]);
    HEATload(content[i++]);
    EMBEDload(content[i++]);
    DOTload(content[i++]);
    TRAKload(content[i++]);
    DUALload(content[i++]);
    DEGload(content[i++]);
    alert("Saved information was loaded successfully!\nYou might start with 'Check All Features' in 'Comb. & Abbr.' tab!");
  };
  reader.readAsText($("#loadfile")[0].files[0]);
  
}

</script>
</body>
</html>



