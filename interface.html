<html>
  <head>
    <!-- for datatables -->
    <link rel="stylesheet" type="text/css" href="static/DataTables/datatables.min.css">
    <script src="static/jquery-ui.min.js"></script>
    <style>
      #sortable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
      #sortable li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.4em; height: 18px; cursor:move; }
      #sortable li span { position: absolute; margin-left: -1.3em; }
      #sortable li.fixed{cursor:default; color:#959595; opacity:0.5;}

      .splitter {
          display: flex;
          width: 100%;
      }
      
      #separator {  
          cursor: col-resize;
          min-width: 6px;
          background-color: #aaa;
          background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAhCAQAAABOpSL+AAAAIklEQVR4AWMwbb/PdR+JZDD9f1/oPhI5sgVGBSruc9xHIgGdSQqqQJGkRgAAAABJRU5ErkJggg==') center center no-repeat #F1F1F1;
      /* prevent browser's built-in drag from interfering */
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
      }
      
      #panel-left {
          background-color: #dde;
          width: 20%;
          white-space: nowrap;
      }
      
      #panel-right {
          background-color: #fff;
          width: 80%;
      }
      #separator, #panel-left, #panel-right {
          vertical-align: top; 
      }

      .block {
        display: block;
        width: 100%;
        border: none;
        background-color: #B6B6B6;
        color: white;
        padding: 4px 28px;
        font-size: 18px;
        cursor: pointer;
        text-align: center;
      }
      .block:hover {
        background-color: #ffff33;
        color: black;
      }

      .tab {
        float: left;
        width: 100%;
        height: 100%;
        
        border: 1px solid #ccc;
        background-color: #f1f1f1;
      }
      .tab button {
        display: block;
        width: 100%;
        text-align: left;
        
        background-color: inherit;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 5px 10px;
        transition: 0.3s;
      }
      .tab button:hover {
        background-color: #ddd;
      }
      .tab button.active {
        background-color: #ccc;
      }
      .tabcontent {
        float: left;
        border-left: none;
        width:100%;
        
        display: none;
        padding: 0px 10px;
      }

      h3 {
        display: block;
        font-size: 1.17em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 0;
        margin-right: 0;
        font-weight: bold;
      }
      .loading {
          width: 50%;
          height: auto;
          position: relative;
      }
      .loading-wheel {
          width: 70px;
          height: 70px;
          margin-top: -60px;
          margin-left: -60px;
          
          position: absolute;
          top: 50%;
          left: 50%;
          
          border-width: 30px;
          border-radius: 50%;
          -webkit-animation: spin 2s linear infinite;
      }
      .style-2 .loading-wheel {
          border-style: double;
          border-color: #99f transparent;
      }
      @-webkit-keyframes spin {
          0% {
              -webkit-transform: rotate(0);
          }
          100% {
              -webkit-transform: rotate(-360deg);
          }
      }
      
      tr:nth-child(even) {background-color: #f2f2f2;}
      input[type=number]{
        width: 60px;
      }
      input,textarea,select{ font-size: 14px; }
    </style>
  </head>
<body>
<div class="splitter">
  <div id="panel-left">
    <div class="tab">
      <button class="tablinks" onclick="selFun(event, 'ADDG')"><b>Add Genes</b></button>
      <button class="tablinks" onclick="selFun(event, 'SGV');$('#SGVnote').text('');if($('#SGVgene').val() == null) $('#SGVnote').text('Please add genes either from the VIP menu or the main window');">Violin</button>
      <button class="tablinks" onclick="selFun(event, 'PGV')">Stacked Violin</button>
      <button class="tablinks" onclick="selFun(event, 'HEAT')">Heatmap</button>
      <button class="tablinks" onclick="selFun(event, 'EMBED')">UMAP/tSNE</button>
      <button class="tablinks" onclick="selFun(event, 'DOT')">Dot Plot</button>
      <button class="tablinks" onclick="selFun(event, 'TRAK')">Track Plot</button>
      <button class="tablinks" onclick="selFun(event, 'DENS')">Density Plot</button>
      <button class="tablinks" onclick="selFun(event, 'DENS2D')">2D Density</button>
      <button class="tablinks" onclick="selFun(event, 'DUAL')">Dual Genes</button>
      <button class="tablinks" onclick="selFun(event, 'SANK')">Sankey Diagram</button>
      <button class="tablinks" onclick="selFun(event, 'GD')">Gene Detected</button>
      <button class="tablinks" onclick="selFun(event, 'DEG')">DEG</button>
      <button class="tablinks" onclick="selFun(event, 'MARK')">Marker Genes</button>
      <hr size="1" noshade>
      <button class="tablinks" onclick="selFun(event, 'IMG')">Figure Option</button>
      <button class="tablinks" onclick="selFun(event, 'ABBR')">Comb. & Abbr.</button>
      <button class="tablinks" onclick="save()">Save Session</button>
      <button class="tablinks" onclick="inputClick()">Load Session</button>
      <button class="tablinks" onclick="ABBRall()">Check All Annotations</button>
      <button class="tablinks" onclick="sync();">Sync</button>
    </div>
  </div>
  <div id="separator" ></div>
  <div id="panel-right" >
    	  
    <input id="loadfile" type="file" onchange="load()" style="display:none"/>
    <div id="ABBR" class="tabcontent"> <!-- Abbreviation -->
      <h3>Create a combinatorial annotation</h3>
      <ol type="1">
        <li><button onclick="ABBRclear()">Uncheck All Annotations</button></li>
        <li><p>Select the annotations of interest on the left panel of main window, then <button onclick="ABBRcombine();ABBRall()">Create</button> a new annotation named "Custom_combine" includes the following categories: <p id="ABBRcombine"></p>
		</li>
      </ol>
    
      <hr>
      <h3>Create abbreviations of annotations</h3><!-- <button onclick="ABBRsave()">Save to local</button><input id="ABBRfile" type="file" value="Load from local" onchange="ABBRload()"/>-->
      <p>Choose annotations:</p>
      <p id="ABBRgrp"></p>
      <p id="ABBRtable"></p>
    </div><!--ABBR-->
    
    <div id="ADDG" class="tabcontent">
      <h3>Add genes of interest for plotting</h3>
      <p>Please input a list of genes (comma, semicolon, space or tab delimited):</p>
      <p><textarea id="ADDGinput" rows="5" cols="70"></textarea></p>
      <p><button onclick="ADDGadd()"><b>Add</b></button></p>
      <p>The following genes were added: <span id="ADDGsel"></span></p>
      <p>The following genes are not in the data: <span id="ADDGdel" style="color:red"></span></p>
      
      <h3>Add gene sets of interest for plotting</h3>
      <p>Gene set name: <input id="ADDGsetName" type="text" size=10/>
        Gene names:<input id="ADDGsetGene" type="text" size=35/>
        <button onclick="ADDGsetAdd()"><b>Add</b></button>
      </p>
      <span id="ADDGsetError" style="color:red"></span><br>
      The user-defined gene sets:
      <p id="ADDGsets"></p>
    </div><!--ADDG-->
    
    <div id="GD" class=tabcontent>
      <div id="GDinput">
        <h3>Genes detected in selected cells </h3>
        <p>In group 1 (<span id="GDcellN1" style="color:red;">0</span>) cells and group 2 (<span id="GDcellN2" style="color:red;">0</span>) cells</p>
        <p>Expression threshold:
        <input id="GDcutoff" type="number" step="0.1" value="1"/></p>
      </div>
      <button class="GDbt" onclick="GDplot()"><b>Plot</b></button>
      <button onclick="ZoomIn('GDresize')">Zoom In</button>
      <button onclick="ZoomOut('GDresize')">Zoom Out</button>
      <button class="GDpngBT" onclick="saveImg('GDimg')" disabled>Save</button>
      <button onclick="hideShow($('#GDinput'),$(this));">Hide Input</button>
      <p id="GDnote" style="color:red;"></p>
      <div id="GDspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="GDresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6">
        <p id="GDfig"></p></div>
    </div><!--GD-->
    
    <div id="MARK" class="tabcontent">
      <div id="MARKinput">
        <h3>Marker genes of annotation categories in selected cells</h3>
        <p>Choose cell set(s):
          <label><input class="MARKcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="MARKcellN1" style="color:red">0</span>)</label>
          <label><input class="MARKcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="MARKcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Select an annotation: 
        <select id="MARKgrp"></select></p>
        <p>By method: 
        <select id="MARKmethod">
          <option value="logreg">logreg</option>
          <option value="t-test">t-test</option>
          <option value="wilcoxon">wilcoxon</option>
          <option value="t-test_overestim_var">t-test_overestim_var</option>
        </select> with the number of genes per group: <input id="MARKn" type="number" step="1" value="10" min="3"/></p>
      </div>
      <button class="MARKbt" onclick="MARKplot()"><b>Find/Plot</b></button>
      <button onclick="ZoomIn('MARKresize')">Zoom In</button>
      <button onclick="ZoomOut('MARKresize')">Zoom Out</button>
      <button class="MARKpngBT" onclick="saveImg('MARKimg')" disabled>Save</button>
      <button onclick="hideShow($('#MARKinput'),$(this));">Hide Input</button>
      <p id="MARKnote" style="color:red;"></p>
      <div id="MARKspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      
      <table id="MARKtable" class="display"></table>
      <div id="MARKresize" style="height: 'auto'">
        <p id="MARKfig"></p>
      </div>
    </div><!--MARK-->
    
    <div id="SGV" class="tabcontent">
      <div id="SGVinput">
        <h3>Violin plot of a gene on selected cells</h3>
        <p>Choose cell set(s):
          <label><input class="SGVcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="SGVcellN1" style="color:red">0</span>)</label>
          <label><input class="SGVcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="SGVcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose a gene:
        <select id="SGVgene"></select> with expression cutoff: <input id="SGVcutoff" type="number" step="0.1" value="1"/></p>
        <p>Group by:
        <select id="SGVgrp"></select></p>
      </div>
      <button class="SGVbt" onclick="SGVplot('plot')"><b>Plot</b></button>
      <button class="SGVsaveBT" onclick="SGVplot('data')">Get Data</button>
      <button onclick="ZoomIn('SGVresize')">Zoom In</button>
      <button onclick="ZoomOut('SGVresize')">Zoom Out</button>
      <button class="SGVpngBT" onclick="saveImg('SGVimg')" disabled>Save</button>
      <button onclick="hideShow($('#SGVinput'),$(this));">Hide Input</button>
      <p id="SGVnote" style="color:red;"></p>
      <div id="SGVspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="SGVresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="SGVfig"></p></div>
    </div><!--SGV-->
    
    <div id="PGV" class="tabcontent">
      <div id="PGVinput">
        <h3>Stacked violin plot of genes on selected cells</h3>
        <p>Choose cell set(s):
          <label><input class="PGVcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="PGVcellN1" style="color:red">0</span>)</label>
          <label><input class="PGVcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="PGVcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose genes with expression cutoff: <input id="PGVcutoff" type="number" step="0.1" value="1"/> <input type="checkbox" checked onclick="$('.PGVgenes').prop('checked', this.checked);">Uncheck / Check All</p>
        <p id="PGVgene"></p>
        <p>Select user-defined gene sets:</p><p id="PGVgeneGrp"></p>
        <div id="PVGgeneGrpCollapsing">
          <p>Collapsing the above gene sets:
            <input type="radio" name="PGVgeneGrpColl" value="Yes" onclick="$('#PGVgeneGrpCollShow').show()">Yes
            <input type="radio" name="PGVgeneGrpColl" value="No" onclick="$('#PGVgeneGrpCollShow').hide()" checked>No
          </p>
          <div id='PGVgeneGrpCollShow'><p>By:
            <input type="radio" name="PGVgeneGrpCollCal" value="mean" checked>Average
            <input type="radio" name="PGVgeneGrpCollCal" value="median">Median</p>
          </div>
       </div>   
          
          
        <p>Group by:<select id="PGVgrp"></select> as
        <select id="PGVgrpXY">
          <option value="Rows">Rows</option>
          <option value="Columns">Columns</option>
        </select>
        </p>
      </div>
      <button class="PGVbt"  onclick="PGVplot('plot')"><b>Plot</b></button>
      <button class="PGVsaveBT" onclick="PGVplot('data')">Get Data</button>
      <button onclick="ZoomIn('PGVresize')">Zoom In</button>
      <button onclick="ZoomOut('PGVresize')">Zoom Out</button>
      <button class="PGVpngBT" onclick="saveImg('PGVimg')" disabled>Save</button>
      <button onclick="hideShow($('#PGVinput'),$(this));">Hide Input</button>
      <p id="PGVnote" style="color:red;"></p>
      <div id="PGVspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="PGVresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="PGVfig"></p></div>
    </div><!--PGV-->
    
    <div id="HEAT" class="tabcontent">
      <div id="HEATinput">
        <h3>Heatmap on selected cells and genes</h3>
        <p>Choose cell set(s):
          <label><input class="HEATcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="HEATcellN1" style="color:red">0</span>)</label>
          <label><input class="HEATcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="HEATcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose genes: <input type="checkbox" checked onclick="$('.HEATgenes').prop('checked', this.checked);">Uncheck / Check All</button></p>
        <p id="HEATgene"></p>
        <p>Clustering by:
        <select id="HEATorder"></select></p>
        <p>Choose annotation:</p>
        <p id="HEATgrp"></p>
        <p>Select plotting value:
        <select id="HEATnorm">
          <option value="X">Expression</option>
          <option value="zscore">Expression Z-score</option>
        </select></p>
      </div>
      <button class="HEATbt"  onclick="HEATplot()"><b>Plot</b></button>
      <button class="HEATsaveBT" onclick="HEATdata()" disabled>Get Data</button>
      <button onclick="ZoomIn('HEATresize')">Zoom In</button>
      <button onclick="ZoomOut('HEATresize')">Zoom Out</button>
      <button class="HEATpngBT" onclick="saveImg('HEATimg')" disabled>Save</button>
      <button onclick="hideShow($('#HEATinput'),$(this));">Hide Input</button>
      <p id="HEATnote" style="color:red;"></p>
      <div id="HEATspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="HEATresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="HEATfig"></p></div>
      <div id="HEATdata" style="visibility: hidden;"></div>
    
    </div><!--HEAT-->
    
    <div id="DOT" class="tabcontent">
      <div id="DOTinput">
        <h3>Dot plot shows per group, the fraction of cells expressing a gene (dot size) and the mean expression of the gene in those cell (color scale)</h3>
        <p>Choose cell set(s):
          <label><input class="DOTcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="DOTcellN1" style="color:red">0</span>)</label>
          <label><input class="DOTcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="DOTcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose genes with expression cutoff: <input id="DOTcutoff" type="number" step="0.1" value="1"/><input type="checkbox" checked onclick="$('.DOTgenes').prop('checked', this.checked);">Uncheck / Check All</p>
        <p id="DOTgene"></p>
        <p>Expression is averaged only over cells expressing a given gene above the cutoff: <input type="radio" name="mean_only_expressed" value="Yes">Yes<input type="radio" name="mean_only_expressed" value="No" checked>No</p>
  
        <p>Select user-defined gene sets:</p><p id="DOTgeneGrp"></p>
        <div id="DOTgeneGrpCollapsing">
          <p>Collapsing the above gene sets:
            <input type="radio" name="DOTgeneGrpColl" value="Yes" onclick="$('#DOTgeneGrpCollShow').show()">Yes
            <input type="radio" name="DOTgeneGrpColl" value="No" onclick="$('#DOTgeneGrpCollShow').hide()" checked>No
          </p>
          <div id='DOTgeneGrpCollShow'><p>By:
            <input type="radio" name="DOTgeneGrpCollCal" value="mean" checked>Average
            <input type="radio" name="DOTgeneGrpCollCal" value="median">Median</p>
          </div>
        </div>

        <p>Group by: <select id="DOTgrp"></select></p>
        <p id="DOTnote" style="color:red;"></p>
      </div>
      <button onclick="DOTplot()"><b>Plot</b></button>
      <button onclick="ZoomIn('DOTresize')">Zoom In</button>
      <button onclick="ZoomOut('DOTresize')">Zoom Out</button>
      <button class="DOTpngBT" onclick="saveImg('DOTimg')" disabled>Save</button>
      <button onclick="hideShow($('#DOTinput'),$(this));">Hide Input</button>
      <div id="DOTspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="DOTresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="DOTfig"></p></div>
    
    </div><!--DOT-->
    
    <div id="EMBED" class="tabcontent">
      <div id="EMBEDinput">
        <h3>Embedding plots on selected genes and annotations</h3>
        <p>Choose cell set(s):
          <label><input class="EMBEDcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="EMBEDcellN1" style="color:red">0</span>)</label>
          <label><input class="EMBEDcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="EMBEDcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose annotation groups:</p>
        <p id="EMBEDgrp"></p>
        <p>Choose genes: <input type="checkbox" checked onclick="$('.EMBEDgenes').prop('checked', this.checked);">Uncheck / Check All</button></p>
        <p id="EMBEDgene"></p>
        <p>Select the annotation group where the gene expression will split: 
        <select id="EMBEDsplit">
          <option value="NONE">NONE</option>
        </select>
        </p>
        <p>Select the embedding layout:
        <select id="EMBEDlayout">
        </select> the number of plots per row:
        <input id="EMBEDslot" type="number" value="4" min="2"/>
        </p>
      </div> 
      <button class="EMBEDbt"  onclick="EMBEDplot()"><b>Plot</b></button>
      <button onclick="ZoomIn('EMBEDresize')">Zoom In</button>
      <button onclick="ZoomOut('EMBEDresize')">Zoom Out</button>
      <button class="EMBEDpngBT" onclick="saveImg('EMBEDimg')" disabled>Save</button>
      <button onclick="hideShow($('#EMBEDinput'),$(this));">Hide Input</button>
      <p id="EMBEDnote" style="color:red;"></p>
      <div id="EMBEDspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="EMBEDresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="EMBEDfig"></p></div>
    
    </div><!--EMBED-->
    
    <div  id="TRAK" class="tabcontent">
      <div id="TRAKinput">
        <h3>Track plot shows the gene expression represented by height</h3>
        <p>Choose cell set(s):
          <label><input class="TRAKcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="TRAKcellN1" style="color:red">0</span>)</label>
          <label><input class="TRAKcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="TRAKcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose genes: <input type="checkbox" checked onclick="$('.TRAKgenes').prop('checked', this.checked);">Uncheck / Check All</p>
        <p id="TRAKgene"></p>
        <p>Select user-defined gene sets: </p><p id="TRAKgeneGrp"></p>
        <div id="TRAKgeneGrpCollapsing">
          <p>Collapsing the above gene sets:
            <input type="radio" name="TRAKgeneGrpColl" value="Yes" onclick="$('#TRAKgeneGrpCollShow').show()">Yes
            <input type="radio" name="TRAKgeneGrpColl" value="No" onclick="$('#TRAKgeneGrpCollShow').hide()" checked>No
          </p>
          <div id='TRAKgeneGrpCollShow'><p>By:
            <input type="radio" name="TRAKgeneGrpCollCal" value="mean" checked>Average
            <input type="radio" name="TRAKgeneGrpCollCal" value="median">Median</p>
          </div>
        </div>

        <p>Group by: <select id="TRAKgrp"></select></p>
      </div>
      <button onclick="TRAKplot()"><b>Plot</b></button>
      <button onclick="ZoomIn('TRAKresize')">Zoom In</button>
      <button onclick="ZoomOut('TRAKresize')">Zoom Out</button>
      <button class="TRAKpngBT" onclick="saveImg('TRAKimg')" disabled>Save</button>
      <button onclick="hideShow($('#TRAKinput'),$(this));">Hide Input</button>
      <p id="TRAKnote" style="color:red;"></p>
      <div id="TRAKspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="TRAKresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="TRAKfig"></p></div>
    
    </div><!--TRAK-->

    <div  id="DENS" class="tabcontent">
      <div id="DENSinput">
        <h3>Density plots of selected genes</h3>
        <p>Choose cell set(s):
          <label><input class="DENScell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="DENScellN1" style="color:red">0</span>)</label>
          <label><input class="DENScell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="DENScellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose genes: <input type="checkbox" checked onclick="$('.DENSgenes').prop('checked', this.checked);">Uncheck / Check All</button></p>
        <p id="DENSgene"></p>
        <p>Split by:
        <select id="DENSsplit"></select></p>
        <p>Color by:
        <select id="DENSgrp"></select></p>
        <p>Bandwidth: <input id="DENSprec" type="number" step="0.1" value="0.5" min="0.1"/> controls how tightly the curve is fit to the data, much like the bin size in a histogram.</p>
      </div>
      <button onclick="DENSplot()"><b>Plot</b></button>
      <button onclick="ZoomIn('DENSresize')">Zoom In</button>
      <button onclick="ZoomOut('DENSresize')">Zoom Out</button>
      <button class="DENSpngBT" onclick="saveImg('DENSimg')" disabled>Save</button>
      <button onclick="hideShow($('#DENSinput'),$(this));">Hide Input</button>
      <p id="DENSerror" style="color:red;"></p>
      <div id="DENSspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="DENSresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="DENSfig"></p></div>
    
    </div><!--DENS-->

    <div  id="DENS2D" class="tabcontent">
      <div id="DENS2Dinput">
        <h3>Embedding plot of two genes in selected cells</h3>
        <p>Choose cell set(s):
          <label><input class="DENS2Dcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="DENS2DcellN1" style="color:red">0</span>)</label>
          <label><input class="DENS2Dcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="DENS2DcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose two genes:</p>
        <p id="DENS2Dgene"></p>
        <p>Please specify the gene expression cutoff: <input id="DENS2Dcutoff" type="number" step="0.1" value="1"/></p>
      </div>
      <button class="DENS2Dbt"  onclick="DENS2Dplot()"><b>Plot</b></button>
      <button onclick="ZoomIn('DENS2Dresize')">Zoom In</button>
      <button onclick="ZoomOut('DENS2Dresize')">Zoom Out</button>
      <button class="DENS2DpngBT" onclick="saveImg('DENS2Dimg')" disabled>Save</button>
      <button onclick="hideShow($('#DENS2Dinput'),$(this));">Hide Input</button>
      <p id="DENS2Dnote" style="color:red;"></p>
      <div id="DENS2Dspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="DENS2Dresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="DENS2Dfig"></p></div>
      
    </div><!--DENS2D-->
      
    <div  id="DUAL" class="tabcontent">
      <div id="DUALinput">
        <h3>Embedding plot of two genes in selected cells</h3>
        <p>Choose cell set(s):
          <label><input class="DUALcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="DUALcellN1" style="color:red">0</span>)</label>
          <label><input class="DUALcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="DUALcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose two genes:</p>
        <p id="DUALgene"></p>
        <p>Please specify the gene expression cutoff: <input id="DUALcutoff" type="number" step="0.1" value="1"/></p>
        <p>Select the embedding layout:
        <select id="DUALlayout">
        </select>
        </p>
      </div>
      <button class="DUALbt"  onclick="DUALplot()"><b>Plot</b></button>
      <button onclick="ZoomIn('DUALresize')">Zoom In</button>
      <button onclick="ZoomOut('DUALresize')">Zoom Out</button>
      <button class="DUALpngBT" onclick="saveImg('DUALimg')" disabled>Save</button>
      <button onclick="hideShow($('#DUALinput'),$(this));">Hide Input</button>
      <p id="DUALnote" style="color:red;"></p>
      <div id="DUALspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="DUALresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6"><p id="DUALfig"></p></div>
      
    </div><!--DUAL-->

    <div  id="SANK" class="tabcontent">
      <div id="SANKinput">
        <h3>Sankey Diagrams on selected cells for selected annotations and/or genes</h3>
        <p>Choose cell set(s):
          <label><input class="SANKcell" type="checkbox" value="celllist1" checked/>Group 1 (<span id="SANKcellN1" style="color:red">0</span>)</label>
          <label><input class="SANKcell" type="checkbox" value="celllist2" checked/>Group 2 (<span id="SANKcellN2" style="color:red">0</span>)</label>
        </p>
        <p>Choose genes: <input type="checkbox" checked onclick="$('.SANKgenes').prop('checked', this.checked);">Uncheck / Check All</button></p>
        <p id="SANKgene"></p>
        <!-- <p>Choose user-defined gene sets:</p><p id="SANKgeneGrp"></p> -->
        <p>Number of equally divided gene expression ranges: <input id="sankBin" type="number" step="1" value="5"/></p>
        <p>Choose annotation:</p><p id="SANKgrp"></p>
        <p>Change the order by dragging items up and down:
        <button id="SANKorderBTs" onclick="SANKorderShow()" style="padding:2px;border-radius:45%"><b>&#43;</b></button>
        <button id="SANKorderBTh" onclick="SANKorderHide()" style="padding:2px;border-radius:40%"><b>&#8722;</b></button>
        </p>
        <div id='SANKorderGrp'>
          <ul id="SANKdynList" class="sortable-list"></ul>
        </div>
        <p>Please specify the diagram <u>width per category</u>: <input id="SANKw" type="number" step="10" value="250"/> and the <u>diagram height</u>: <input id="SANKh" type="number" step="10" value="700"/></p>
      </div>
      <button class="SANKbt"  onclick="SANKplot()"><b>Plot</b> </button>
      <button onclick="hideShow($('#SANKinput'),$(this));">Hide Input</button>
      <button class="SANKbt" style="float:right;" onclick="for (let item of document.getElementsByClassName('node-label-guide')) {item.setAttribute('style', 'display:none');}; var a = document.createElement('a'); a.href = 'data:application/octet-stream;base64,' + btoa(document.getElementsByClassName('main-svg')[0].outerHTML); a.download = 'Sankey.svg'; a.click();">Save as SVG</button></p>

      <p id="SANKnote" style="color:red;"></p>
      <div id="SANKspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <div id="SANKresize" style="height: 'auto'; width: 'auto'; padding: 0.5em;"></div>
      
    </div><!--SANK-->
    
    <div id="DEG" class="tabcontent">
      <div id="DEGinput">
        <h3>Find differentially expressed genes</h3>
        <p>Group 1 (<span id="DEGcellN1" style="color:red;">0</span>) cells and group 2 (<span id="DEGcellN2" style="color:red;">0</span>) cells</p>
        <p>Differentially expressed genes will be detected between the two cell gorups defined above, unless two categories of the 'Custom_combine' annotation are selected, 
        which enables DE analysis between those two:</p>
        <p id="DEGgrp"></p>
        <p>Select the number of top DEG: 
        <select id="DEGtop">
          <option value=100>100</option>
          <option value=500>500</option>
          <option value=1000>1000</option>
          <option value=2000>2000</option>
          <option value=5000>5000</option>
        </select></p>
        <p>Select the method: 
        <select id="DEGmethod">
          <option value='t-test'>Welch’s t-test</option>
          <option value='rank'>Wilcoxon rank sum</option>
          <option value='wald'>Wald test</option>
        </select></p>
        <p>Select genes to be marked in the volcano plot: <input type="checkbox" onclick="$('.DEGgenes').prop('checked', this.checked);">Uncheck / Check All</button></p>
        <p id="DEGgene"></p>
      </div>
      
      <button class="DEGbt" onclick="DEGfind()"><b>Find</b></button>
      <button class="DEGpngBT" onclick="saveImg('DEGimg')" disabled>Save</button>
      <button onclick="hideShow($('#DEGinput'),$(this));">Hide Input</button>
      <p id="DEGnote" style="color:red;"></p>
      <label id='DEGinfo'></label>
      <div id="DEGspin" class="loading style-2" style="visibility: hidden;"><div class="loading-wheel"></div></div>
      <table id="DEGtable" class="display"></table>
      <button onclick="ZoomIn('DEGresize')">Zoom In</button>
      <button onclick="ZoomOut('DEGresize')">Zoom Out</button>
      <div id="DEGresize" style="height: 'auto'; padding: 0.5em; border: 1px solid #B6B6B6">
        <p id="DEGfig"></p>
      </div>
    </div><!--DEG-->
    
    <div id="IMG" class="tabcontent">
      <div><p>Scale data to unit variance for plotting: 
        <input type="radio" name="IMGscale" value="Yes" onclick="IMGset()">Yes
        <input type="radio" name="IMGscale" value="No" onclick="IMGset()">No
        </p>
        <div id="IMGscaleShow">
          <Blockquote>
            <input id="IMGscaleZero" type="checkbox" onclick="IMGset()"/> Zero Center
            <input id="IMGclipValue" type="checkbox" onclick="IMGset()"/> Capped at a maximum value of <input id="IMGscaleMax" type="number" step="0.1" onchange="IMGset()"/> after scaling
          </Blockquote>
        </div>
      </div>
      <p>Figure DPI (Dots Per Inch): 
      <select id="IMGdpi" onchange="IMGset()">
        <option value=150>150</option>
        <option value=300>300</option>
        <option value=600>600</option>
      </select></p>
      <p>Figure format: 
      <select id="IMGimg" onchange="IMGset()">
        <option value='png'>PNG</option>
        <option value='svg'>SVG</option>
      </select></p>
      <p>Font size:
      <input id="IMGfontsize" type="number" step="1" value="11" min="5" onchange="IMGset()"/></p>  
      <p>Vector friendly:
        <input type="radio" name="IMGvector" value="Yes" onclick="IMGset()" checked>Yes
        <input type="radio" name="IMGvector" value="No" onclick="IMGset()">No
      </p>  
      <p>Transparent figure:
        <input type="radio" name="IMGtransparent" value="Yes" onclick="IMGset()">Yes
        <input type="radio" name="IMGtransparent" value="No" onclick="IMGset()" checked>No
      </p>  
      <p>Colormap of UMAP/tSNE, 2D Density (top 4):
      <select id="IMGcolor" onchange="IMGset()">
        <option value='viridis'>viridis</option>
        <option value='plasma'>plasma</option>
        <option value='inferno'>inferno</option>
        <option value='magma'>magma</option>
        <option value='spring'>spring</option>
        <option value='summer'>summer</option>
        <option value='autumn'>Fall</option>
        <option value='winter'>winter</option>
      </select></p>  
      <table border=0>
        <tr><td>viridis</td><td rowspan=8><img src="static/color_map.png" height="180px"></tr>
        <tr><td>plasma</td></tr>
        <tr><td>inferno</td></tr>
        <tr><td>magma</td></tr>
        <tr><td>spring</td></tr>
        <tr><td>summer</td></tr>
        <tr><td>Fall</td></tr>
        <tr><td>winter</td></tr>
      </table>

    </div><!--IMG-->
	  
  </div>
</div>

<!-- <button class="block" onclick="sync()">Refresh</button> -->

<script type="text/javascript">
var heatCell = 10000;
function checkLoading(){
    if(!window.store || !window.store.getState().categoricalSelection){
      return false;
    }
    var cateN = 0;
    for(const one of window.store.getState().universe.schema.annotations.obs.columns){
      if(one.type=='categorical'){
        cateN++;
      }
    }
//    if(cateN!=Object.keys(window.store.getState().categoricalSelection).filter(function(e) { return !window.store.getState().categoricalSelection[e].isTruncated }).length) {
//      return false;
//    }
    if(cateN!=Object.keys(window.store.getState().categoricalSelection).length) {
      return false;
    }
    return true;
}
function enableButton(){
    if(!checkLoading()){
      for(const one of document.getElementsByClassName('tablinks')){
        one.disabled=true;
      }
      setTimeout(enableButton, 100);
    }else{
      for(const one of document.getElementsByClassName('tablinks')){
        one.disabled=false;
      }
      if (window.store.getState().categoricalSelection[">Description"] !== undefined) {
        if(window.store.getState().categoricalSelection[">Description"].categoryValues[0].split("|").length>1){
          var ginit = window.store.getState().categoricalSelection[">Description"].categoryValues[0].split("|")[1].split(";");
          window.store.dispatch({type: "set layout choice", layoutChoice: ginit[0].split("by")[1].trim()});
          window.store.dispatch({type: "color by categorical metadata", colorAccessor: ginit[1].split("by")[1].trim()});
          window.store.dispatch({type: "show centroid labels for category", showLabels: true});
        }
      }
      window.store.dispatch({type: "store current cell selection as differential set 1", data:Int32Array.from({length:window.store.getState().universe.nObs},(v,k)=>k)});
      init();
    }
    //var d = new Date();
    //console.log(d.getTime());
}
enableButton();

function dragElement( element, direction){
    var   md; // remember mouse down info
    const pLeft  = document.getElementById("panel-left");
    const pRight = document.getElementById("panel-right");
    
    element.onmousedown = onMouseDown;
    
    function onMouseDown( e )
    {
    	//console.log("mouse down: " + e.clientX);
    	md = {e,
    	      panelW:pLeft.parentElement.offsetWidth,
    	      lper:parseInt(pLeft.style.width)
    	};
      document.onmousemove = onMouseMove;
      document.onmouseup = () => { 
          document.onmousemove = document.onmouseup = null;
      }
      console.log(md);
    }
    
    function onMouseMove( e )
    {
      var moveR = Math.ceil(100*(e.clientX - md.e.x)/md.panelW);
    	if (direction === "H" ) // Horizontal
    	{
    	    // prevent negative-sized elements
    	    moveR = (moveR < -md.lper) ? 0 : (moveR > (99-md.lper)) ? 0 : moveR;

          element.style.left = md.lper+moveR+"%";
          pLeft.style.width = md.lper+moveR+"%";
          pRight.style.width = (100-(md.lper+moveR)) +"%";
    	}
    }
}
dragElement( document.getElementById("separator"), "H" );

function selFun(evt,sel){
  var i, tabC, tabL;
  tabC = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabC.length; i++) {
    tabC[i].style.display = "none";
  }
  tabL = document.getElementsByClassName("tablinks");
  for (i = 0; i < tabL.length; i++) {
    tabL[i].className = tabL[i].className.replace(" active", "");
  }
  document.getElementById(sel).style.display = "block";
  evt.currentTarget.className += " active";
  sync();
}
function ZoomIn(strDiv){
  var r = $("#"+strDiv).width() / $("#"+strDiv).parent().width() * 100;
  r += 5;
  $("#"+strDiv).width(r+'%');//Math.min(95,r)
}
function ZoomOut(strDiv){
  var r = $("#"+strDiv).width() / $("#"+strDiv).parent().width() * 100;
  r -= 5;
  $("#"+strDiv).width(Math.max(10,r)+'%');
}
function showImg(eID,data){
  if (['SGVfig','HEATfig'].includes(eID)) {
    document.getElementById(eID).innerHTML = '<img id="'+eID.replace('fig','img')+'" src="data:image/'+window.figOpt['img'].replace('svg','svg+xml')+';base64,'+data+'" width="100%" height="100%"/>';
  } else {
    document.getElementById(eID).innerHTML = '<img id="'+eID.replace('fig','img')+'" src="data:image/'+window.figOpt['img'].replace('svg','svg+xml')+';base64,'+data+'" width="100%" height="auto"/>';
  } 
  
}
function saveImg(pngID){
  var gh = document.getElementById(pngID).src;
  var a = document.createElement('a');
  a.href = gh;
  a.download = pngID+"."+window.figOpt['img'];
  a.target="_blank";
  a.click();
}
function cellNupdate(){
  var n1=0,n2=0;
  if(!!window.store.getState().differential.celllist1){
    n1 = window.store.getState().differential.celllist1.length;
  }
  if(!!window.store.getState().differential.celllist2){
    n2 = window.store.getState().differential.celllist2.length;
  }
  $('#MARKcellN1').text(n1);
  $('#SGVcellN1').text(n1);
  $('#PGVcellN1').text(n1);
  $('#HEATcellN1').text(n1);
  $('#DOTcellN1').text(n1);
  $('#DEGcellN1').text(n1);
  $('#GDcellN1').text(n1);
  $('#EMBEDcellN1').text(n1);
  $('#TRAKcellN1').text(n1);
  $('#DUALcellN1').text(n1);
  $('#DENScellN1').text(n1);
  $('#DENS2DcellN1').text(n1);
  $('#SANKcellN1').text(n1);

  $('#MARKcellN2').text(n2);
  $('#SGVcellN2').text(n2);
  $('#PGVcellN2').text(n2);
  $('#HEATcellN2').text(n2);
  $('#DEGcellN2').text(n2);
  $('#DOTcellN2').text(n2);
  $('#GDcellN2').text(n2);
  $('#EMBEDcellN2').text(n2);
  $('#TRAKcellN2').text(n2);
  $('#DUALcellN2').text(n2);
  $('#DENScellN2').text(n2);
  $('#DENS2DcellN2').text(n2);
  $('#SANKcellN2').text(n2);
}

//Page Initial functions
function createOpt(val){
  var opt = document.createElement("option");
  opt.text = val;
  opt.value = val;
  return(opt)
}
function init(){
  if(!('bioInit' in window)){
    //----------------
    $("#panel-left").prop('style')['width'] = "20%";
    $("#separator").prop('style')['left'] = "20%";
    $("#panel-right").prop('style')['width'] = "80%";
    //--------------------------------------------------------------------------
    //ABBRinit
    var grps = Object.keys(window.store.getState().categoricalSelection).sort();
    var grpL = window.store.getState().categoricalSelection;
    var htmlCheck= "";
    for(i=0;i<grps.length;i++){
      var one = grps[i];
      if (one.startsWith(">")) continue;
      htmlCheck += '<label><input class="ABBRgrps" type="checkbox" value="'+grps[i]+'" onclick="ABBRlist()"/> '+grps[i]+' ('+grpL[grps[i]].numCategoryValues+')</label>';
    }  
    $('#ABBRgrp').html(htmlCheck);
    
    var bioAbbr = {}
    for(i=0;i<grps.length;i++){
      var one = {}
      for(var j=0;j<grpL[grps[i]].numCategoryValues;j++){
        one[grpL[grps[i]].categoryValues[j]] = grpL[grps[i]].categoryValues[j].toString();
      }
      bioAbbr[grps[i]] = one;
    }
    window.bioAbbr=bioAbbr;
    window.bioCombine={};
    window.bioCombineCell={};
    window.biogen=[];
    window.bioGeneGrp={};
    window.figOpt={scale:'No',scaleZero:'No',clipValue:'Yes',scaleMax:20,dpi:150,img:'png',fontsize:11,vectorFriendly:'Yes',transparent:'No',colorMap:'viridis'};
    if (grpL[">Description"] !== undefined && !grpL[">Description"].categoryValues[0].split(";")[1].includes("scale")) {
      window.figOpt['scale'] = "Yes";
    }

    //--------------------------------------------------------------------------
    //add dropdown annotation categories
    var sgv = document.getElementById("SGVgrp");
    var pgv = document.getElementById("PGVgrp");
    var heat = document.getElementById("HEATorder");
    var dot = document.getElementById("DOTgrp");
    var trak = document.getElementById("TRAKgrp");
    var mark = document.getElementById("MARKgrp");
    var densS = document.getElementById("DENSsplit");
    var densG = document.getElementById("DENSgrp");
    var embed = document.getElementById("EMBEDsplit");
    for(const one of grps){
      if (one.startsWith(">")) continue; 
      sgv.add(createOpt(one));
      pgv.add(createOpt(one));
      heat.add(createOpt(one));
      dot.add(createOpt(one));
      trak.add(createOpt(one));
      mark.add(createOpt(one));
      densS.add(createOpt(one));
      densG.add(createOpt(one));
      embed.add(createOpt(one));
    }
    //--------------------------------------------------------------------------
    //add layout
    var embedLay = document.getElementById("EMBEDlayout");
    var dualLay = document.getElementById("DUALlayout");
    for(const ix of Object.keys(window.store.getState().universe.schema.layout.obs)){
      embedLay.add(createOpt(window.store.getState().universe.schema.layout.obs[ix].name));
      dualLay.add(createOpt(window.store.getState().universe.schema.layout.obs[ix].name));
    }
    //--------------------------------------------------------------------------
    htmlCheck= "";
    for(const one of grps){
      if (one.startsWith(">")) continue; 
      htmlCheck += '<label><input class="eIDgrps" type="checkbox" value="'+one+'"/> '+one+' ('+grpL[one].numCategoryValues+')</label>';
    }  
    //HEAT, EMBED
    $('#HEATgrp').html(htmlCheck.replace(/eID/g,'HEAT'));
    $('#EMBEDgrp').html(htmlCheck.replace(/eID/g,'EMBED'));
    $('#SANKgrp').html(htmlCheck.replace(/eID/g,'SANK').replace(/value/g,'onchange="SANKorderUpdate()" value'));
    
    //SANK
    $("#SANKorderGrp").hide();
    document.getElementById("SANKorderBTh").style.display="none";
    $('.sortable-list').sortable({
        connectWith: '.sortable-list',
        placeholder: 'sortable-list-dropholder'
        //console.log("init SANK")
    });
    //obtain the minimal expression value
    /*
    $.ajax({
      type:"POST",
      url: "/VIP",
      data:JSON.stringify({'method':"MINX"}),
      contentType: 'application/json;charset=UTF-8',//
      success: function(res){
        $('#GDcutoff').prop('min',res);
        $('#DUALcutoff').prop('min',res);
        $('#DOTcutoff').prop('min',res);
      }
    })*/
    $('#SGVcutoff').prop('min',0);
    $('#PGVcutoff').prop('min',0);  
    $('#GDcutoff').prop('min',0);
    $('#DUALcutoff').prop('min',0);
    $('#DOTcutoff').prop('min',0);  

    const unsubscribe = window.store.subscribe(() => {
      if (window.store.getState()["@@undoable/filterState"].prevAction) {
        actionType = window.store.getState()["@@undoable/filterState"].prevAction.type;
        if (actionType.includes("user defined gene success") || actionType.includes("store current cell selection as differential set")) {
          sync();
        }
      }
    });
    
    window.bioInit=true;
  }
  return true;
}
//Page sync functions
function sync(){
  cellNupdate();
  ABBRref();
  ADDGref();
  GDref();
  SGVref();
  PGVref();
  HEATref();
  DOTref();
  TRAKref();
  DUALref();
  DEGref();
  EMBEDref();
  IMGref();
  DENSref();
  DENS2Dref();
  SANKref();
}
function ABBRref(){
}
function ADDGref(){
  var genes =  window.biogen;
  $("#ADDGsel").text(genes.join(", "));
  
  var html= "";
  var grpKeys = Object.keys(window.bioGeneGrp);
  for(const one of grpKeys){
    html += "<p><button onclick=\"ADDGsetDel('"+one+"')\"><b>Delete</b></button> <b>"+one+"</b>: " + window.bioGeneGrp[one]+"</p>";
  }
  $("#ADDGsets").html(html);

}
function GDref(){
}
function addCustomCombine(element) {
  var x = document.getElementById(element);
  var grps = Object.keys(window.store.getState().categoricalSelection).filter(function(e) { return !(e.startsWith('>') || e.startsWith('|')) });
  var grpKeys = Object.keys(window.bioCombine);
  if(grpKeys.length>0 && grps.length==x.length){
    x.add(createOpt("Custom_combine"));
  }else if(grpKeys.length==0 && grps.length<x.length){
    x.remove(grps.length);
  }
}
function MARKref(){
  addCustomCombine("MARKgrp");
}
function SGVref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  optG = [];
  var i,x = document.getElementById("SGVgene");
  //remove options which are not in the gene list
  $("#SGVgene option").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      x.remove($(this).index())
    }
  });
  //add options which are missing from gene list
  if(genes.length>0){
    for(const g of genes){
      if(!optG.includes(g)){
        x.add(createOpt(g));
      }
    }
  }
  addCustomCombine("SGVgrp");
  if($('#SGVgene').val()) $('#SGVnote').text('');
}
function showGeneSet(aID){
  var gSets = Object.keys(window.bioGeneGrp);
  var optG = [], NcheckG=[];
  //remove checkbox which are not in the gene list
  $("."+aID+"sets").each(function(){
    optG.push($(this).val());
    if(!gSets.includes($(this).val())){
      $('#'+aID+'ck'+$(this).val()).remove();
    }else if($(this).prop("checked") == false){
      NcheckG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(gSets.length>0){
    var htmlCheck = $('#'+aID+'geneGrp').html();
    for(const g of gSets){
      if(!optG.includes(g)){
        htmlCheck += '<label id="'+aID+'ck'+g+'"><input class="'+aID+'sets" type="checkbox" value="'+g+'" checked/>'+g+'</label>';// '+g+'
      }
    }
    $('#'+aID+'geneGrp').html(htmlCheck);
  }
  $("."+aID+"sets").each(function(){
    if(NcheckG.includes($(this).val())){
      $(this).prop("checked",false);
    }
  })
  
}
function showGene(aID, addInfo='', ckDefault='checked'){
  //console.log(aID+":"+ckDefault+":"+addInfo);
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  var optG = [], NcheckG=[],checkG=[];
  //remove checkbox which are not in the gene list
  $("."+aID+"genes").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      $('#'+aID+'ck'+$(this).val()).remove();
    }else if($(this).prop("checked") == false){
      NcheckG.push($(this).val());
    }else if($(this).prop("checked")){
      checkG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(genes.length>0){
    var htmlCheck = $('#'+aID+'gene').html();
    for(const g of genes){
      if(!optG.includes(g)){
        htmlCheck += '<label id="'+aID+'ck'+g+'"><input class="'+aID+'genes" type="checkbox" value="'+g+'" '+ckDefault+' '+addInfo+'/>'+g+'</label>';// '+g+'
      }
    }
    $('#'+aID+'gene').html(htmlCheck);
  }
  $("."+aID+"genes").each(function(){
    if(NcheckG.includes($(this).val())){
      $(this).prop("checked",false);
    }else if(checkG.includes($(this).val())){
      $(this).prop("checked",true);
    }
  })
}
function showGeneGrpCollSet(aID){
  if(Object.keys(window.bioGeneGrp).length>0){
    $('#'+aID+'geneGrpCollapsing').show();
  }else{
    $('#'+aID+'geneGrpCollapsing').hide();
  }
  if($("input[name='"+aID+"geneGrpColl']:checked").val() == 'Yes'){
    $('#'+aID+'geneGrpCollShow').show();
  }else{
    $('#'+aID+'geneGrpCollShow').hide();
  }  
}
function PGVref(){
  showGene('PGV');
  showGeneSet('PGV');
  addCustomCombine("PGVgrp");
  showGeneGrpCollSet("PGV");
}
function HEATref(){
  showGene('HEAT');

  var nCells = 0;
  var x = document.getElementsByClassName('HEATcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked && !!window.store.getState().differential[x[i].value]){
      nCells += window.store.getState().differential[x[i].value].length;
    }
  }
  var grps = Object.keys(window.store.getState().categoricalSelection); 
  x = document.getElementById("HEATorder");
  if(nCells<heatCell && grps.length==x.length){
    x.add(createOpt("Expression"));
  }else if(nCells>heatCell && grps.length<x.length){
    x.remove(grps.length);
  }
}
function DOTref(){
  showGene('DOT');
  showGeneSet('DOT');
  addCustomCombine("DOTgrp");
  showGeneGrpCollSet("DOT");
}
function TRAKref(){
  showGene('TRAK');
  showGeneSet('TRAK');
  addCustomCombine("TRAKgrp");
  showGeneGrpCollSet("TRAK");
}
function DENSref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  var optG = [], NcheckG=[];
  //remove checkbox which are not in the gene list
  $(".DENSgenes").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      $('#DENSck'+$(this).val()).remove();
    }else if($(this).prop("checked") == false){
      NcheckG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(genes.length>0){
    var htmlCheck = $('#DENSgene').html();
    for(const g of genes){
      if(!optG.includes(g)){
        htmlCheck += '<label id="DENSck'+g+'"><input class="DENSgenes" type="checkbox" value="'+g+'" checked/>'+g+'</label>';//
      }
    }
    $('#DENSgene').html(htmlCheck);
  }
  $(".DENSgenes").each(function(){
    if(NcheckG.includes($(this).val())){
      $(this).prop("checked",false);
    }
  })
  addCustomCombine("DENSgrp");
  addCustomCombine("DENSsplit");
}
function DENS2Dref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  var optG = [], checkG=[];
  //remove checkbox which are not in the gene list
  $(".DENS2Dgenes").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      $('#DENS2Dck'+$(this).val()).remove();
    }else if($(this).prop("checked")){
      checkG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(genes.length>0){
    var htmlCheck = $('#DENS2Dgene').html();
    for(const g of genes){
      if(!optG.includes(g)){
        htmlCheck += '<label id="DENS2Dck'+g+'"><input class="DENS2Dgenes" type="checkbox" value="'+g+'" onclick="DENS2Dref()"/>'+g+'</label>';// '+g+'
      }
    }
    $('#DENS2Dgene').html(htmlCheck);
  }
  var iEnabled=0;
  $(".DENS2Dgenes").each(function(){
    if(checkG.includes($(this).val())){
      $(this).prop("checked",true);
      iEnabled++;
    }
  })
  if(iEnabled>1){
    $(".DENS2Dgenes").each(function(){
      if($(this).prop("checked")==false){
        $(this).prop("disabled",true);
      }
    })
  }else{
    $('.DENS2Dgenes').prop("disabled",false);
  }
  
}
function EMBEDref(){
  showGene('EMBED');
}
function DUALref(){
  var genes = window.store.getState().universe.varData.colIndex.rindex;
  genes = genes.concat(window.biogen);
  genes = [...new Set(genes)];
  var optG = [], checkG=[];
  //remove checkbox which are not in the gene list
  $(".DUALgenes").each(function(){
    optG.push($(this).val());
    if(!genes.includes($(this).val())){
      $('#DUALck'+$(this).val()).remove();
    }else if($(this).prop("checked")){
      checkG.push($(this).val());
    }
  })
  //add options which are missing from gene list
  if(genes.length>0){
    var htmlCheck = $('#DUALgene').html();
    for(const g of genes){
      if(!optG.includes(g)){
        htmlCheck += '<label id="DUALck'+g+'"><input class="DUALgenes" type="checkbox" value="'+g+'" onclick="DUALref()"/>'+g+'</label>';// '+g+'
      }
    }
    $('#DUALgene').html(htmlCheck);
  }
  var iEnabled=0;
  $(".DUALgenes").each(function(){
    if(checkG.includes($(this).val())){
      $(this).prop("checked",true);
      iEnabled++;
    }
  })
  if(iEnabled>1){
    $(".DUALgenes").each(function(){
      if($(this).prop("checked")==false){
        $(this).prop("disabled",true);
      }
    })
  }else{
    $('.DUALgenes').prop("disabled",false);
  }
  
}
function SANKref(){
  showGene('SANK','onchange="SANKorderUpdate()"');
  //showGeneSet('SANK');
  SANKorderUpdate();
}
function SANKorderUpdate(){
  var selSank = [];
  $(".SANKgrps").each(function(){
    if($(this).prop("checked")){
      selSank.push($(this).val());
  }})
  selSank = selSank.concat(getGenes('SANK'));
  selSank=selSank.map(function(one){return 'SANKli'+one;})
  
  for(const one of $("#SANKdynList").sortable('toArray')){
    if(!selSank.includes(one)){
      $(document.getElementById(one)).remove();
    }
  }
  selSank = [...new Set($("#SANKdynList").sortable('toArray').concat(selSank))];

  var htmlCheck = "";
  for(const one of selSank){
    htmlCheck += "<li id='"+one+"'><label>"+one.replace("SANKli","")+"</label></li>";
  }
  $("#SANKdynList").html(htmlCheck);
}
function SANKorderShow(){
  $("#SANKorderGrp").show();
	document.getElementById("SANKorderBTs").style.display="none";
  document.getElementById("SANKorderBTh").style.display="inline";
}
function SANKorderHide(){
  $("#SANKorderGrp").hide();
	document.getElementById("SANKorderBTh").style.display="none";
  document.getElementById("SANKorderBTs").style.display="inline";
}
function DEGref(){
  showGene('DEG',"","");
  
  var cName=[],cVal=Object.keys(window.bioCombineCell);
  for(const one of Object.values(window.bioCombineCell)){
    cName.push(one.cName);
  }
  
  var optG = [], checkG=[];
  //remove checkbox which are not in the annotation list
  $(".DEGgrps").each(function(){
    optG.push($(this).val());
    if(!cVal.includes($(this).val())){
      $('#DEGck'+$(this).val()).remove();
    }else if($(this).prop("checked")){
      checkG.push($(this).val());
    }
  })
  //add options which are missing from annotation list
  if(cVal.length>0){
    var htmlCheck = $('#DEGgrp').html();
    for(var i=0;i<cVal.length;i++){
      if(!optG.includes(cVal[i])){
        htmlCheck += '<label id="DEGck'+cVal[i]+'"><input class="DEGgrps" type="checkbox" value="'+cVal[i]+'" onclick="DEGref()"/>'+cName[i]+'</label>';
      }
    }
    $('#DEGgrp').html(htmlCheck);
  }

  //check the originally checked
  var iEnabled=0;
  $(".DEGgrps").each(function(){
    if(checkG.includes($(this).val())){
      $(this).prop("checked",true);
      iEnabled++;
    }
  })
  //disable when 2 are checked or enable when less than 2 is checked
  if(iEnabled>1){
    $(".DEGgrps").each(function(){
      if($(this).prop("checked")==false){
        $(this).prop("disabled",true);
      }
    })
  }else{
    $('.DEGgrps').prop("disabled",false);
  }
 
}
function IMGref(){
  $('#IMGscaleZero').prop('checked',(window.figOpt['scaleZero']=="Yes"));
  $('#IMGclipValue').prop('checked',(window.figOpt['clipValue']=="Yes"));
  $('#IMGscaleMax').val(window.figOpt['scaleMax']);
  if(window.figOpt['scale'] == "Yes"){
    $('#IMGscaleShow').show();
    $("input[name='IMGscale'][value='Yes']").prop('checked', true);
  }else{
    $('#IMGscaleShow').hide();
    $("input[name='IMGscale'][value='No']").prop('checked', true);
  }

  $('#IMGdpi').val(window.figOpt['dpi']);
  $('#IMGimg').val(window.figOpt['img']);
  $('#IMGfontsize').val(window.figOpt['fontsize']);
  $('#IMGvector').val(window.figOpt['vectorFriendly']);
  $('#IMGtransparent').val(window.figOpt['transparent']);
  $('#IMGcolor').val(window.figOpt['colorMap']);
}
function IMGset(){
  window.figOpt['scale'] = $("input[name='IMGscale']:checked").val();
  if(window.figOpt['scale'] == "Yes"){
    $('#IMGscaleShow').show();
    window.figOpt['scaleZero'] = $('#IMGscaleZero').prop('checked')?"Yes":"No";
    window.figOpt['clipValue'] = $('#IMGclipValue').prop('checked')?"Yes":"No";
    window.figOpt['scaleMax'] = $('#IMGscaleMax').val();
  }else{
    $('#IMGscaleShow').hide();
  }

  window.figOpt['dpi'] = $('#IMGdpi').val();
  window.figOpt['img'] = $('#IMGimg').val();
  window.figOpt['fontsize'] = Math.max($('#IMGfontsize').val(),$('#IMGfontsize').prop('min'));
  window.figOpt['vectorFriendly'] = $("input[name='IMGvector']:checked").val();
  window.figOpt['transparent'] = $("input[name='IMGtransparent']:checked").val();
  window.figOpt['colorMap'] = $('#IMGcolor').val();
  //IMGref();
}
// process annotation
function ABBRlist(){
  var grps = {},nrows=0,i;
  var x = document.getElementsByClassName('ABBRgrps');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      grps[x[i].value]=window.store.getState().categoricalSelection[x[i].value].categoryValues.map(String);
      nrows = Math.max(nrows,grps[x[i].value].length);
    }
  }
  var grpKey = Object.keys(grps);
  var htmlTable = "<table style='width:100%;border-collapse: collapse;'><tr>";
  for(i=0;i<grpKey.length;i++){
    htmlTable += "<th colspan='2' style='background-color: #4CAF50;color: white;'>"+grpKey[i]+"</th>"
  }
  htmlTable += "</tr><tr>";
  for(i=0;i<nrows;i++){
    for(var j=0;j<grpKey.length;j++){
      if(j>0){
        htmlTable += "<td align='right' style='border-left:2px solid #888'>"
      }else{
        htmlTable += "<td align='right'>"
      }
      if(i<grps[grpKey[j]].length){//grpKey[j]+"','"+grps[grpKey[j]][i]
        htmlTable += grps[grpKey[j]][i]+'</td><td><input type="text" id="'+grpKey[j]+"|"+grps[grpKey[j]][i]+'" value="' +window.bioAbbr[grpKey[j]][grps[grpKey[j]][i]]+'" onchange=ABBRupdate(["'+grpKey[j].replace(/ /g,";;")+'","'+grps[grpKey[j]][i].replace(/ /g,";;")+'"])></td>';
      }else{
        htmlTable += "</td><td></td>";
      }
    }
    htmlTable += "</tr><tr>"
  }
  htmlTable += "</tr></table>"
  $('#ABBRtable').html(htmlTable);
}
function ABBRupdate(eID){
  for(var i=0;i<eID.length;i++){
    eID[i] = eID[i].replace(/;;/g," ");
  }
  window.bioAbbr[eID[0]][eID[1]] = $('#'+eID.join("\\|").replace(/ /g,"\\ ")).val();
}
function ABBRclear(){
  var grpKeys = Object.keys(window.store.getState().categoricalSelection);
  for(var i=0;i<grpKeys.length;i++) {
    window.store.dispatch({type: "categorical metadata filter none of these", metadataField: grpKeys[i]});
  }
  return;
}
function ABBRall(){
  var grpKeys = Object.keys(window.store.getState().categoricalSelection);
  for(var i=0;i<grpKeys.length;i++) {
    window.store.dispatch({type: "categorical metadata filter all of these", metadataField: grpKeys[i]});
  }
  return;
}
//const indexOfAll = (arr, val) => arr.reduce((acc, el, i) => (el === val ? [...acc, i] : acc), []);
function ABBRcombineCell(){
  var annKeys = Object.keys(window.store.getState().categoricalSelection);
  var obsMap = window.store.getState().universe.obsAnnotations.colIndex.index;
  var grpKeys = Object.keys(window.bioCombine);
  var cName = [], cVal = [];//, selC=[]
  for(const key of grpKeys){
    var k = annKeys.indexOf(key);
    if(cName.length==0){
      for(const v of window.bioCombine[key]){
        cName.push(window.bioAbbr[key][v]);
        cVal.push(k+"_"+window.store.getState().categoricalSelection[key].categoryValueIndices.get(v));
        //selC.push(indexOfAll(window.store.getState().universe.obsAnnotations.__columns[obsMap.get(key)],v));
      }
    }else{
      var newGrp = [], newVal = [];//, newC = []
      for(var i=0;i<cName.length;i++){
        window.bioCombine[key].forEach(function(v){
          newGrp.push(cName[i]+":"+window.bioAbbr[key][v]);
          newVal.push(cVal[i]+"__"+k+"_"+window.store.getState().categoricalSelection[key].categoryValueIndices.get(v));
          //var oneSel = indexOfAll(window.store.getState().universe.obsAnnotations.__columns[obsMap.get(key)],v);
          //newC.push(selC[i].filter(v => oneSel.includes(v)));
        });
      }
      cName = newGrp;
      cVal = newVal;
      //selC = newC;
    }
  }
  var combCell = {};
  for(var i=0;i<cName.length;i++){
    //cName[i] += " ("+selC[i].length+")";
    //var cells = new Int32Array(selC[i].length);
    //cells.set(selC[i]);
    combCell[cVal[i]] = {cName:cName[i]};//,selC:cells
  }
  return combCell;
}
function ABBRcombine(){
  window.bioCombine={};
  var combGrp = {};
  var grpKeys = Object.keys(window.store.getState().categoricalSelection);
  for(var i=0;i<grpKeys.length;i++) {
    if(window.store.getState().categoricalSelection[grpKeys[i]].categorySelected){
      combGrp[grpKeys[i]] = window.store.getState().categoricalSelection[grpKeys[i]].categoryValues;
    }else{
      var one = [];
      for(var j=0;j<window.store.getState().categoricalSelection[grpKeys[i]].numCategoryValues;j++){
        if(window.store.getState().categoricalSelection[grpKeys[i]].categoryValueSelected[j]){
          one.push(window.store.getState().categoricalSelection[grpKeys[i]].categoryValues[j]);
        }
      }
      if(one.length>0){
        combGrp[grpKeys[i]] = one;
      }
    }
  }
  window.bioCombine=combGrp;
  window.bioCombineCell = ABBRcombineCell();
  var combVal = [];
  for(const one of Object.values(window.bioCombineCell)){
    combVal.push(one.cName);
  }
  
  $('#ABBRcombine').html("<span style='color:red;'><strong>"+combVal.join('; ')+"</strong></span>");
}
function ABBRcombineUpdate(){
  var combGrp = window.bioCombine;
  var combKey = Object.keys(combGrp);
  var allGrp = window.store.getState().categoricalSelection;
  for(var i=0;i<combKey.length;i++){
    //console.log(allGrp[combKey[i]].categoryValues);
    for(var j=0;j<allGrp[combKey[i]].numCategoryValues;j++){
      if(combGrp[combKey[i]].includes(allGrp[combKey[i]].categoryValues[j])){
        window.store.dispatch({type: "categorical metadata filter select", metadataField: combKey[i], categoryIndex: j});
        //console.log([combKey[i],allGrp[combKey[i]].categoryValues[j]]);
      }
    }
  }
  return;
}
// process genes
function ADDGadd(){
  var addG = $("#ADDGinput").val().split(/\s+|\,|\;/);
  var genes =  window.biogen;
  var notG = [];
  var totalG = window.store.getState().universe.varAnnotations.__columns[0];
  var totalGlower = totalG.map(function(s){return s.toLowerCase();});
  
  for(var i=0;i<addG.length;i++){
    var one = addG[i].trim();
    if (addG[i].trim().length<1)
      continue;
    var ix = totalGlower.indexOf(one.toLowerCase());
    if(ix !== -1){
      var oneG = totalG[ix];
      if(!genes.includes(oneG)){
        genes.push(oneG);
      }
    }else{
      notG.push(one);
    }
  }
  $("#ADDGdel").text(notG.join(", "));
  $("#ADDGinput").val("");
  ADDGref();
}
function ADDGsetAdd(){
  $("#ADDGsetError").text("");
  var grpName = $("#ADDGsetName").val().trim();
  if(grpName.length<1){
    $("#ADDGsetError").text("Please provide a gene set name with at least one character!");
    return;
  }
  var grpKeys = Object.keys(window.bioGeneGrp);
  if(grpKeys.includes(grpName)){
    $("#ADDGsetError").text("The gene set name exists!");
    return;
  }
  var definedG = [];
  for(var i=0;i<grpKeys.length;i++){
    definedG = definedG.concat(window.bioGeneGrp[grpKeys[i]]);
  }
  
  var gNames = $("#ADDGsetGene").val().trim().split(/\s+|\,|\;/);
  var notG = [],geneNames=[];
  var totalG = window.store.getState().universe.varAnnotations.__columns[0];
  var totalGlower = totalG.map(function(s){return s.toLowerCase();});
  for(var i=0;i<gNames.length;i++){
    var one = gNames[i].trim();
    var ix = totalGlower.indexOf(one.toLowerCase());
    if(ix !== -1){
      var oneG = totalG[ix];
      if (one.length<1) continue;
      if(!definedG.includes(oneG)){
        geneNames.push(oneG);
      }else{
        notG.push(one);
      }
    }else{
      notG.push(one);
    }
  }
  var eMsg= "";
  if(notG.length>0){
    eMsg +="The following genes cannot be found in the data or defined in previous gene sets: "+notG;
    $("#ADDGsetError").text(eMsg);
  }
  if(geneNames.length==0){
    $("#ADDGsetError").text(eMsg+". No valid gene names is provided");
    return;
  }
  $("#ADDGsetName").val("");
  $("#ADDGsetGene").val("");
  window.bioGeneGrp[grpName] = geneNames;

  geneNames = geneNames.concat(window.biogen);
  geneNames = [...new Set(geneNames)];
  window.biogen = geneNames;
  ADDGref();
}
function ADDGsetDel(grpName){
  delete window.bioGeneGrp[grpName];
  ADDGref();
}
function hideShow(section, button) {
  section.toggle();
  button.text(button.text()=='Hide Input'?'Show Input':'Hide Input');
}
// plot function 
function GDplot(){
  if(!window.store.getState().differential.celllist1 && !window.store.getState().differential.celllist2){
    $('#GDnote').text("Please select cells into group 1 or/and group 2");
    return;
  }
  var cells = {};
  if(window.store.getState().differential.celllist1){
    cells['group1'] = window.store.getState().differential.celllist1;
  }
  if(window.store.getState().differential.celllist2){
    cells['group2'] = window.store.getState().differential.celllist2;
  }
  if(+$('#GDcutoff').prop('min') > +$("#GDcutoff").val()){
    $('#GDnote').text("The minimal expression level is: "+$('#GDcutoff').prop('min'));
    return;
  }

  var D = {'method':'GD',
            'cells':cells,
            'cutoff':$("#GDcutoff").val(),
            'figOpt':window.figOpt};
  $(".GDbt").prop('disabled',true);
  $(".GDpngBT").prop('disabled',true);
  document.getElementById("GDspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',
    success: function(res){
      $(".GDbt").prop("disabled",false);
      document.getElementById("GDspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#GDnote').text(res);
        document.getElementById("GDfig").innerHTML = '<img id="GDpng" src="data:image/png;base64," width=100% height="auto"/>';
        return;
      }
      showImg('GDfig',res);
      $(".GDpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#GDnote').text(request.status+request.responseText);
      document.getElementById("GDfig").innerHTML = '<img id="GDpng" src="data:image/png;base64," width=100% height="auto"/>';
      $(".GDbt").prop("disabled",false);
      document.getElementById("GDspin").style.visibility="hidden";
    }
  });

}
function MARKplot(){
  var cells=[], x = document.getElementsByClassName('MARKcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#MARKnote').text("Please use selection tools to put cells into groups");
    return;
  }
  
  if($("#MARKn").val()<3){
    $('#MARKnote').text("Minimal number of markers per group is 3");
    return;
  }
  var grp = [$("#MARKgrp option:selected").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  
  
  $(".MARKbt").prop("disabled",true);
  $(".MARKpngBT").prop('disabled',true);
  document.getElementById("MARKspin").style.visibility="visible";
  var D = {'method':'MARK',
            'cells':cells,
            'genes':[],
            'grp':grp,
            'markMethod':$("#MARKmethod option:selected").val(),
            'geneN':$("#MARKn").val(),
            'abb':window.bioAbbr,
            'combine':combGrp,
            'figOpt':window.figOpt};
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      document.getElementById("MARKspin").style.visibility="hidden";
      $(".MARKbt").prop("disabled",false);
      if(res.startsWith('ERROR')){
        $('#MARKnote').text(res);
        $('#MARKtable').empty();
        document.getElementById("MARKfig").innerHTML = '';
        return;
      }

      resD = JSON.parse(res);
      var tD = resD[0];
      var keyD = tD.shift();
      var titleD = [];
      for(const one of keyD){
        titleD.push({'title':one})
      }
      $('#MARKtable').empty();
      var table = $('#MARKtable').DataTable({
        destroy: true,
        dom:'Blfrtip',
        lengthMenu:[[10,50,100,200,-1],[10,50,100,200,"All"]],
        order:[[1,"dsc"]],
        buttons:['csv'],
        data:tD,
        columns:titleD
      });

      $('#MARKtable tbody').on('click',"tr",function(){
        var data = table.row(this).data();
        //alert('Your clicked on '+data[0]+" row");
        var genes =  window.biogen;
        if(genes.includes(data[0])){
          genes.splice(genes.indexOf(data[0]),1);
        }else{
          genes.push(data[0]);
        }
        $('#MARKnote').text("Selected genes: "+genes.join(", "));
      });
      showImg('MARKfig',resD[1]);
      $(".MARKpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#MARKnote').text(request.status+request.responseText);
      $('#MARKtable').empty();
      document.getElementById("MARKfig").innerHTML = '';
      $(".MARKbt").prop("disabled",false);
      document.getElementById("MARKspin").style.visibility="hidden";
    }
  })

}
function SGVplot(acc){
  $('#SGVnote').text("");
  if($("#SGVgene option:selected").val()=="NA"){
    $('#SGVnote').text("Please select a gene to plot");
    return;
  }
  if($("#SGVgrp option:selected").val()=="NA"){
    $('#SGVnote').text("Please select a category to plot");
    return;
  }
  var cells=[], x = document.getElementsByClassName('SGVcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if($('#SGVgene').val() == null) {
    $('#SGVnote').text('Please add genes either from the VIP menu or the main window');
    return;
  }
  if(cells.length==0){
    $('#SGVnote').text("Please use selection tools to put cells into groups");
    return;
  }
  if(+$("#SGVcutoff").val() < +$("#SGVcutoff").prop('min')){
    $('#SGVnote').text("The minimal expression level is "+$("#SGVcutoff").prop('min'));
    return;
  }
  //$('#SGVnote').text("Plotting on "+cells.length+" selected cells");
  var grp = [$("#SGVgrp").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  
  var D = {'method':'SGV',
            'cells':cells,
            'genes':[$("#SGVgene").val()],
            'grp':grp,
            'abb':window.bioAbbr,
            'cutoff':$("#SGVcutoff").val(),
            'combine':combGrp,
            'figOpt':window.figOpt};
  if(acc=='data') D['method']='VIOdata';
  $(".SGVbt").prop("disabled",true);
  $(".SGVsaveBT").prop('disabled',true);
  $(".SGVpngBT").prop('disabled',true);
  document.getElementById("SGVspin").style.visibility="visible";
  
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".SGVbt").prop("disabled",false);
      $(".SGVsaveBT").prop('disabled',false);
      document.getElementById("SGVspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#SGVnote').text(res);
        document.getElementById("SGVfig").innerHTML = '';
        return;
      }
      if(acc=='data'){
        var hiddenE = document.createElement('a');
        hiddenE.href="data:attachment/text,"+encodeURIComponent(res);
        hiddenE.target='_blank';
        hiddenE.download='cellxgene.'+window.store.getState().config.displayNames.dataset+'.violinData.csv';
        hiddenE.click();
      }else{
        showImg('SGVfig',res);
      }
      //document.getElementById("SGVfig").innerHTML = '<img id="SGVpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".SGVpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#SGVnote').text(request.status+request.responseText);
      document.getElementById("SGVfig").innerHTML = '<img id="SGVpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".SGVbt").prop("disabled",false);
      document.getElementById("SGVspin").style.visibility="hidden";
    }
  })
}
function getGeneSet(aID){
  var grpKeys=[];
  $("."+aID+"sets").each(function(){
    if($(this).prop("checked")){
      grpKeys.push($(this).val());
    }
  });
  var selSets={};
  for(const one of grpKeys){
    selSets[one]=window.bioGeneGrp[one];
  }
  return(selSets)
}
function getGenes(aID){
  var genes = [];
  $("."+aID+"genes").each(function(){
    if($(this).prop("checked")){
      genes.push($(this).val());
    }
  });
  return(genes);
}
function PGVplot(acc){
  $('#PGVnote').text("");
  var genes =getGenes('PGV');
  var geneSets = getGeneSet('PGV');

  if(genes.length==0&&Object.keys(geneSets).length==0){
    $('#PGVnote').text("Please select at least a gene or a gene set to plot");
    return;
  }
  
  if($("#PGVgrp option:selected").val()=="NA"){
    $('#PGVnote').text("Please select a category to plot");
    return;
  }
  var cells=[], x = document.getElementsByClassName('PGVcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#PGVnote').text("Please use selection tools to put cells into groups");
    return;
  }
  if(+$("#PGVcutoff").val()< +$("#PGVcutoff").prop('min')){
    $('#PGVnote').text("The minimal expression level is "+$("#PGVcutoff").prop('min'));
    return;
  }

  var grp = [$("#PGVgrp").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  var geneGrpColl = $("input[name='PGVgeneGrpColl']:checked").val()
  if( geneGrpColl== 'Yes'){
    geneGrpColl = $("input[name='PGVgeneGrpCollCal']:checked").val()
  }
  var D = {'method':'PGV',
            'cells':cells,
            'genes':genes,
            'geneGrp':geneSets,
            'geneGrpColl':geneGrpColl,
            'grp':grp,
            'by':$("#PGVgrpXY").val(),
            'abb':window.bioAbbr,
            'cutoff':$("#PGVcutoff").val(),
            'combine':combGrp,
            'figOpt':window.figOpt};
  if(acc=='data') D['method']='VIOdata';
  $(".PGVbt").prop('disabled',true);
  $(".PGVsaveBT").prop('disabled',true);
  $(".PGVpngBT").prop('disabled',true);
  document.getElementById("PGVspin").style.visibility="visible";

  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".PGVbt").prop("disabled",false);
      $(".PGVsaveBT").prop("disabled",false);
      document.getElementById("PGVspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#PGVnote').text(res);
        document.getElementById("PGVfig").innerHTML = '';
        return;
      }
      if(acc=='data'){
        var hiddenE = document.createElement('a');
        hiddenE.href="data:attachment/text,"+encodeURIComponent(res);
        hiddenE.target='_blank';
        hiddenE.download='cellxgene.'+window.store.getState().config.displayNames.dataset+'.violinData.csv';
        hiddenE.click();
      }else{
        showImg('PGVfig',res);
      }
      //document.getElementById("PGVfig").innerHTML = '<img id="PGVpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".PGVpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#PGVnote').text(request.status+request.responseText);
      document.getElementById("PGVfig").innerHTML = '<img id="PGVpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".PGVbt").prop("disabled",false);
      document.getElementById("PGVspin").style.visibility="hidden";

    }
  })
}
function violinData(){
  
}
function HEATcheck(){
  $('#HEATnote').text("");
  var cells=[], x = document.getElementsByClassName('HEATcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }

  if(cells.length==0){
    $('#HEATnote').text("Please use selection tools to put cells into groups");
    return;
  }

  var genes = getGenes('HEAT');
  if(genes.length<2){
    $('#HEATnote').text("It needs at least two genes");
    return;
  }
  
  var grps = [];
  x = document.getElementsByClassName('HEATgrps');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      grps.push(x[i].value);
    }
  }
  var orderGrp = $("#HEATorder").val();
  if(orderGrp=="Expression" && cells.length>heatCell){
    $('#HEATnote').text("Clustering by expression is not available for the number of selected cells larger than "+Math.round(heatCell/1000)+"k.");
    return;
  }
  if(orderGrp!="Expression" && !grps.includes(orderGrp)){
    grps.push(orderGrp);
  }
  if(grps.length==0){
    $('#HEATnote').text("Please select groups to plot");
    return;
  }
  document.getElementById("HEATspin").style.visibility="visible";
  $(".HEATbt").prop('disabled',true);
  $(".HEATpngBT").prop('disabled',true);
  $(".HEATsaveBT").prop('disabled',true);
  var D = {'method':'HEAT',
            'cells':cells,
            'genes':genes,
            'order':orderGrp,
            'norm':$("#HEATnorm option:selected").val(),
            'grp':grps,
            'figOpt':window.figOpt};
  return D;
}
function HEATplot(){
  D = HEATcheck();
  if(D==undefined) return;
  D['method'] = 'HEATplot';
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".HEATbt").prop("disabled",false);
      document.getElementById("HEATspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#HEATnote').text(res);
        document.getElementById("HEATfig").innerHTML = '';
        return;
      }

      showImg('HEATfig',res);//resD[0]
      //document.getElementById("HEATfig").innerHTML = '<img id="HEATpng" src="data:image/png;base64,'+resD[0]+'" width=100% height="auto"/>';// height="450" width="450"
      $(".HEATpngBT").prop('disabled',false);
      $(".HEATsaveBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#HEATnote').text(request.status+request.responseText);
      document.getElementById("HEATfig").innerHTML = '<img id="HEATpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".HEATbt").prop("disabled",false);
      document.getElementById("HEATspin").style.visibility="hidden";

    }
  });
}
function HEATdata(){
  D = HEATcheck();
  if(D==undefined) return;
  D['method'] = 'HEATdata';
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".HEATbt").prop("disabled",false);
      document.getElementById("HEATspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#HEATnote').text(res);
        return;
      }

      var hiddenE = document.createElement('a');
      hiddenE.href="data:attachment/text,"+encodeURIComponent(res);
      hiddenE.target='_blank';
      hiddenE.download='cellxgene.'+window.store.getState().config.displayNames.dataset+'.heatmapData.csv';
      hiddenE.click();

      $(".HEATpngBT").prop('disabled',false);
      $(".HEATsaveBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#HEATnote').text(request.status+request.responseText);
      document.getElementById("HEATfig").innerHTML = '<img id="HEATpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".HEATbt").prop("disabled",false);
      document.getElementById("HEATspin").style.visibility="hidden";

    }
  });
}
function DEGselCells(){
  var selAnno = {};
  var selNames = [];
  //var selC = {};
  var grpKey = Object.keys(window.store.getState().categoricalSelection);
  $(".DEGgrps").each(function(){
    if($(this).prop("checked")){
      selNames.push(window.bioCombineCell[$(this).val()].cName);
      //selC[window.bioCombineCell[$(this).val()].cName.split(' ')[0]] = window.bioCombineCell[$(this).val()].selC;
      //window.store.getState().categoricalSelection[key].categoryValueIndices.get(v)
      $(this).val().split("__").forEach(function(one){
        [k,v]=one.split("_");
        if(selAnno[grpKey[k]]==undefined){selAnno[grpKey[k]]=[]}
        if(!selAnno[grpKey[k]].includes(window.store.getState().categoricalSelection[grpKey[k]].categoryValues[v])){
          selAnno[grpKey[k]].push(window.store.getState().categoricalSelection[grpKey[k]].categoryValues[v]);
        }
      });
    }
  })
  return [selAnno,selNames];
  //return selC;
}
function DEGfind(){
  var genes = getGenes('DEG');
  var D = {'method':'DEG',
           'topN':$("#DEGtop").val(),
           'DEmethod':$("#DEGmethod").val(),
           'genes':genes,
           'figOpt':window.figOpt}
  const [combGrp,combName] = DEGselCells();
  var cells = {};
  if(combName.length!=2){
    if(!window.store.getState().differential.celllist1 || !window.store.getState().differential.celllist2){
      $('#DEGnote').text("Please select cells into both group 1 and group 2");
      return;
    }else{
      cells['group1'] = window.store.getState().differential.celllist1;
      cells['group2'] = window.store.getState().differential.celllist2;
    }
    D['cells'] = cells;
    $('#DEGinfo').text("DEG between selected group 1 and group 2");
  }else{
    D['combine']=combGrp;
    D['abb']=window.bioAbbr;
    D['grp'] = Object.keys(combGrp);
    D['cells'] = new Int32Array(Array(window.store.getState().universe.nObs).keys());
    D['comGrp'] = combName;
    $('#DEGinfo').text("DEG between "+combName.join(" and "));
  }

  document.getElementById("DEGspin").style.visibility="visible";
  $(".DEGbt").prop('disabled',true);
  $(".DEGpngBT").prop('disabled',true);
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      document.getElementById("DEGspin").style.visibility="hidden";
      $(".DEGbt").prop("disabled",false);
      $(".DEGpngBT").prop('disabled',false);
      $('#DEGtable').empty();
      
      if(res.startsWith('ERROR')){
        $('#DEGnote').text(res);
        return;
      }
      resD = JSON.parse(res);
      var table = $('#DEGtable').DataTable({
        destroy: true,
        dom:'Blfrtip',
        lengthMenu:[[10,50,100,200,-1],[10,50,100,200,"All"]],
        order:[[3,"asc"]],
        buttons:['csv'],
        data:resD[0],
        columns:[
          {title: "Gene"},
          {title: "Log Fold Change"},
          {title: "p-value"},
          {title: "padj"}
        ]
      });
      showImg('DEGfig',resD[1]);
      
      $('#DEGnote').text("");
      $('#DEGtable tbody').on('click',"tr",function(){
        var data = table.row(this).data();
        //alert('Your clicked on '+data[0]+" row");
        var genes =  window.biogen;
        if(genes.includes(data[0])){
          genes.splice(genes.indexOf(data[0]),1);
        }else{
          genes.push(data[0]);
        }
        $('#DEGnote').text("Selected genes: "+genes.join(", "));
      });
    },
    error: function(request,status,error){
      $('#DEGnote').text(request.status+request.responseText);
      $('#DEGtable').empty();
      document.getElementById("DEGspin").style.visibility="hidden";
      $(".DEGbt").prop("disabled",false);
    }
  })
  
}
function DOTplot(){
  $('#DOTnote').text("");
  var genes =getGenes('DOT');
  var geneSets = getGeneSet('DOT');

  if(genes.length==0&&Object.keys(geneSets).length==0){
    $('#DOTnote').text("Please select at least a gene or a gene set to plot");
    return;
  }

  var cells=[], x = document.getElementsByClassName('DOTcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#DOTnote').text("Please use selection tools to put cells into groups");
    return;
  }

  if(+$('#DOTcutoff').prop('min') > +$("#DOTcutoff").val()){
    $('#DOTnote').text("The minimal expression level is: "+$('#DOTcutoff').prop('min'));
    return;
  }
  
  var grp = [$("#DOTgrp").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  var geneGrpColl = $("input[name='DOTgeneGrpColl']:checked").val()
  if( geneGrpColl== 'Yes'){
    geneGrpColl = $("input[name='DOTgeneGrpCollCal']:checked").val()
  }
  var D = {'method':'DOT',
            'cells':cells,
            'genes':genes,
            'grp':grp,
            'abb':window.bioAbbr,
            'combine':combGrp,
            'geneGrp':geneSets,
            'geneGrpColl':geneGrpColl,
            'cutoff':$("#DOTcutoff").val(),
            'mean_only_expressed':$("input[name='mean_only_expressed']:checked").val(),
            'figOpt':window.figOpt};
  $(".DOTbt").prop('disabled',true);
  document.getElementById("DOTspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".DOTbt").prop("disabled",false);
      document.getElementById("DOTspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#DOTnote').text(res);
        document.getElementById("DOTfig").innerHTML = '';
        return;
      }
      
      showImg('DOTfig',res)
      //document.getElementById("DOTfig").innerHTML = '<img id="DOTpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".DOTpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#DOTnote').text(request.status+request.responseText);
      document.getElementById("DOTfig").innerHTML = '<img id="DOTpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".DOTbt").prop("disabled",false);
      document.getElementById("DOTspin").style.visibility="hidden";
    }
  })
}
function TRAKplot(){
  $('#TRAKnote').text("");
  var genes =getGenes('TRAK');
  var geneSets = getGeneSet('TRAK');
  if(genes.length==0&&Object.keys(geneSets).length==0){
    $('#TRAKnote').text("Please select at least a gene or a gene set to plot");
    return;
  }

  var cells=[], x = document.getElementsByClassName('TRAKcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#TRAKnote').text("Please use selection tools to put cells into groups");
    return;
  }
  
  var grp = [$("#TRAKgrp").val()];
  var combGrp = [];
  if(grp[0]=="Custom_combine"){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  var geneGrpColl = $("input[name='TRAKgeneGrpColl']:checked").val()
  if( geneGrpColl== 'Yes'){
    geneGrpColl = $("input[name='TRAKgeneGrpCollCal']:checked").val()
  }

  var D = {'method':'TRAK',
            'cells':cells,
            'genes':genes,
            'grp':grp,
            'abb':window.bioAbbr,
            'combine':combGrp,
            'geneGrp':geneSets,
            'geneGrpColl':geneGrpColl,
            'figOpt':window.figOpt};
  $(".TRAKbt").prop('disabled',true);
  document.getElementById("TRAKspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".TRAKbt").prop("disabled",false);
      document.getElementById("TRAKspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#TRAKnote').text(res);
        document.getElementById("TRAKfig").innerHTML = '';
        return;
      }

      showImg('TRAKfig',res);
      //document.getElementById("TRAKfig").innerHTML = '<img id="TRAKpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".TRAKpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#TRAKnote').text(request.status+request.responseText);
      document.getElementById("TRAKfig").innerHTML = '<img id="TRAKpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".TRAKbt").prop("disabled",false);
      document.getElementById("TRAKspin").style.visibility="hidden";
    }
  })
  
}
function DENSplot(){
  $('#DENSerror').text("");
  var cells=[], x = document.getElementsByClassName('DENScell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#DENSerror').text("Please use selection tools to put cells into groups");
    return;
  }
  
  var genes = getGenes('DENS');
  if(genes.length<1){
    $('#DENSerror').text("It needs at least a gene");
    return;
  }
  if(+$("#DENSprec").val() < +$("#DENSprec").prop('min')){
    $('#DENSerror').text("The minimal bandwidth is "+$("#DENSprec").prop('min'));
    return;
  }
  
  var category = [$("#DENSsplit").val(),$("#DENSgrp").val()];
  var combGrp = [];
  var grp= [];
  if(category.includes("Custom_combine")){
    grp = Object.keys(window.bioCombine);
    combGrp = window.bioCombine;
  }
  if($("#DENSsplit").val()!="Custom_combine"){
    grp.push($("#DENSsplit").val())
  }
  if($("#DENSgrp").val()!="Custom_combine"){
    grp.push($("#DENSgrp").val())
  }

  var bw = $("#DENSprec").val();
  var D = {'method':'DENS',
            'cells':cells,
            'genes':genes,
            'grp':grp,
            'bw':bw,
            'category':category,
            'abb':window.bioAbbr,
            'combine':combGrp,
            'figOpt':window.figOpt};
  $(".DENSbt").prop('disabled',true);
  document.getElementById("DENSspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".DENSbt").prop("disabled",false);
      document.getElementById("DENSspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#DENSerror').text(res);
        document.getElementById("DENSfig").innerHTML = '';
        return;
      }

      showImg('DENSfig',res);
      //document.getElementById("TRAKfig").innerHTML = '<img id="TRAKpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".DENSpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#DENSerror').text(request.status+request.responseText);
      document.getElementById("DENSfig").innerHTML = '<img id="DENSpng" src="data:image/png;base64," width=100% height="auto"/>';// height="450" width="450"
      $(".DENSbt").prop("disabled",false);
      document.getElementById("DENSspin").style.visibility="hidden";
    }
  })
            
}
function DENS2Dplot(){
  $('#DENS2Dnote').text("");
  var cells=[], x = document.getElementsByClassName('DENS2Dcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#DENS2Dnote').text("Please use selection tools to put cells into groups");
    return;
  }
  
  var genes = [];
  $(".DENS2Dgenes").each(function(){
    if($(this).prop("checked")){
      genes.push($(this).val());
    }
  })
  if(genes.length!=2){
    $('#DENS2Dnote').text("Please select two genes to plot");
    return;
  }

  document.getElementById("DENS2Dspin").style.visibility="visible";
  $(".DENS2Dbt").prop('disabled',true);
  $(".DENS2DpngBT").prop('disabled',true);

  var D = {'method':"DENS2D",
            'cells':cells,
            'genes':genes,
            'grp':[],
            //'layout':$("#DUALlayout").val(),
            'cutoff':$("#DENS2Dcutoff").val(),
            'figOpt':window.figOpt};
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".DENS2Dbt").prop("disabled",false);
      document.getElementById("DENS2Dspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#DENS2Dnote').text(res);
        document.getElementById("DENS2Dfig").innerHTML = '';
        return;
      }

      showImg('DENS2Dfig',res);
      $(".DENS2DpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#DENS2Dnote').text(request.status+request.responseText);
      document.getElementById("DENS2Dfig").innerHTML = '';// height="450" width="450"
      $(".DENS2Dbt").prop("disabled",false);
      document.getElementById("DENS2Dspin").style.visibility="hidden";
    }
  })
  
}
function EMBEDplot(){
  $('#EMBEDnote').text("");
  var cells=[], x = document.getElementsByClassName('EMBEDcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#EMBEDnote').text("Please use selection tools to put cells into groups");
    return;
  }
  
  var genes = getGenes('EMBED');
  if(genes.length==0){
    $('#EMBEDnote').text("Please select a gene to plot");
    return;
  }
  
  var grps = [];
  x = document.getElementsByClassName('EMBEDgrps');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      grps.push(x[i].value);
    }
  }
  if(grps.length==0){
    $('#EMBEDnote').text("Please select groups to plot");
    return;
  }
  if($('#EMBEDslot').val()<2){
    $('#EMBEDnote').text("The minimal number of plots per row is 2");
    return;
  }
  
  
  document.getElementById("EMBEDspin").style.visibility="visible";
  $(".EMBEDbt").prop('disabled',true);
  $(".EMBEDpngBT").prop('disabled',true);

  var D = {'method':"EMBED",
            'cells':cells,
            'genes':genes,
            'grp':grps,
            'ncol':$('#EMBEDslot').val(),
            'layout':$("#EMBEDlayout").val(),
            'figOpt':window.figOpt};
  if($("#EMBEDsplit").val()!="NONE"){
    D['splitGrp'] = $("#EMBEDsplit").val();
    grps.push($("#EMBEDsplit").val());
    D['grp'] = [...new Set(grps)];
  }
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".EMBEDbt").prop("disabled",false);
      document.getElementById("EMBEDspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#EMBEDnote').text(res);
        document.getElementById("EMBEDfig").innerHTML = '';
        return;
      }

      showImg('EMBEDfig',res);
      //document.getElementById("EMBEDfig").innerHTML = '<img id="EMBEDpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".EMBEDpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#EMBEDnote').text(request.status+request.responseText);
      document.getElementById("EMBEDfig").innerHTML = '';// height="450" width="450"
      $(".EMBEDbt").prop("disabled",false);
      document.getElementById("EMBEDspin").style.visibility="hidden";
    }
  })

}
function DUALplot(){
  $('#DUALnote').text("");
  var cells=[], x = document.getElementsByClassName('DUALcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#DUALnote').text("Please use selection tools to put cells into groups");
    return;
  }
  
  var genes = [];
  $(".DUALgenes").each(function(){
    if($(this).prop("checked")){
      genes.push($(this).val());
    }
  })
  if(genes.length!=2){
    $('#DUALnote').text("Please select two genes to plot");
    return;
  }
  if(+$('#DUALcutoff').prop('min') > +$("#DUALcutoff").val()){
    $('#DUALnote').text("The minimal expression level is: "+$('#DUALcutoff').prop('min'));
    return;
  }
  
  document.getElementById("DUALspin").style.visibility="visible";
  $(".DUALbt").prop('disabled',true);
  $(".DUALpngBT").prop('disabled',true);

  var D = {'method':"DUAL",
            'cells':cells,
            'genes':genes,
            'grp':[],
            'layout':$("#DUALlayout").val(),
            'cutoff':$("#DUALcutoff").val(),
            'figOpt':window.figOpt};
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".DUALbt").prop("disabled",false);
      document.getElementById("DUALspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#DUALnote').text(res);
        document.getElementById("DUALfig").innerHTML = '';
        return;
      }

      showImg('DUALfig',res);
      //document.getElementById("DUALfig").innerHTML = '<img id="DUALpng" src="data:image/png;base64,'+res+'" width=100% height="auto"/>';// height="450" width="450"
      $(".DUALpngBT").prop('disabled',false);
    },
    error: function(request,status,error){
      $('#DUALnote').text(request.status+request.responseText);
      document.getElementById("DUALfig").innerHTML = '';// height="450" width="450"
      $(".DUALbt").prop("disabled",false);
      document.getElementById("DUALspin").style.visibility="hidden";
    }
  })
}
function SANKcheck(){
  $('#SANKnote').text("");
  var cells=[], x = document.getElementsByClassName('SANKcell');
  for(i=0;i<x.length;i++){
    if(x[i].checked){
      if(!!window.store.getState().differential[x[i].value]){
        if(cells.length==0){
          cells = window.store.getState().differential[x[i].value];
        }else{
          var tmp = new Int32Array(cells.length+window.store.getState().differential[x[i].value].length);
          tmp.set(cells);
          tmp.set(window.store.getState().differential[x[i].value],cells.length);
          cells = tmp;
        }
      }
    }
  }
  if(cells.length==0){
    $('#SANKnote').text("Please use selection tools to put cells into groups");
    return;
  }
  var genes =getGenes('SANK');
  //var geneSets = getGeneSet('SANK');
  var grp = [];
  $(".SANKgrps").each(function(){
  if($(this).prop("checked")){
    grp.push($(this).val());
  }})
  
  var selSank = $("#SANKdynList").sortable('toArray');
  selSank=selSank.map(function(one){return one.replace("SANKli","");})
  if (selSank.length < 2) {
    $('#SANKnote').text("Please select at least two features (gene or annotation) to plot");
    return;
  }
  var D = {'method':'SANK',
            'cells':cells,
            'genes':genes,
            //'geneGrp':geneSets,
            'grp':grp,
            'sankOrder':selSank,
            'sankBin':$("#sankBin").val(),
            'imgW':$("#SANKw").val(),
            'imgH':$("#SANKh").val(),
            'abb':window.bioAbbr,
            'figOpt':window.figOpt};
  return(D);  
}
function SANKplot(){
  D = SANKcheck();
  if (!D) return;
  $(".SANKbt").prop('disabled',true);
  document.getElementById("SANKspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".SANKbt").prop("disabled",false);
      document.getElementById("SANKspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#SANKnote').text(res);
        $('#SANKresize').text("");
        return;
      }
      $('#SANKresize').html(res);

    },
    error: function(request,status,error){
      $('#SANKnote').text(request.status+request.responseText);
      $(".SANKbt").prop("disabled",false);
      document.getElementById("SANKspin").style.visibility="hidden";

    }
  })
}
function SANKimgSave(){
  var D = SANKcheck();
  if (!D) return;
  D['imgSave'] = 'svg';
  $(".SANKbt").prop('disabled',true);
  document.getElementById("SANKspin").style.visibility="visible";
  $.ajax({
    type:"POST",
    url: "/VIP",
    data:JSON.stringify(D),
    contentType: 'application/json;charset=UTF-8',//
    success: function(res){
      $(".SANKbt").prop("disabled",false);
      document.getElementById("SANKspin").style.visibility="hidden";
      if(res.startsWith('ERROR')){
        $('#SANKnote').text(res);
        $('#SANKresize').text("");
        return;
      }
      var a = document.createElement('a');
      a.href = "data:image/svg+xml;base64,"+res;//
      a.download = "Sankey.svg";
      a.target="_blank";
      a.click();
    },
    error: function(request,status,error){
      $('#SANKnote').text(request.status+request.responseText);
      $(".SANKbt").prop("disabled",false);
      document.getElementById("SANKspin").style.visibility="hidden";

    }
  })
  
}
//save and load
function checkSave(eID){
  var notCK = [];
  for(const one of $("."+eID+":checkbox:not(:checked)")){
    notCK.push(one.value);
  }
  return notCK;
}
function checkLoad(eID,notCK){
  for(const one of $("."+eID)){
    if(notCK.includes(one.value)){
      one.checked=false;
    }else{
      one.checked=true;
    }
  }
}
function ABBRsave(){
  return [window.bioAbbr,window.bioCombine,checkSave('ABBRgrps')];
}
function ABBRload(content){
  window.bioAbbr= content[0];
  window.bioCombine = content[1];
  checkLoad("ABBRgrps",content[2]);
  
  ABBRlist();
  ABBRclear();
  ABBRcombineUpdate();
  ABBRcombine();
}
function ADDsave(){
  return [window.biogen,window.bioGeneGrp];
}
function ADDload(content){
  window.biogen = content[0];
  window.bioGeneGrp = content[1];
  sync();
}
function IMGsave(){
  return(window.figOpt);
}
function IMGload(content){
  Object.keys(content).forEach(function(k) {
    window.figOpt[k] = content[k];
  });
}

function GDsave(){
  var cells = {'celllist1':[],'celllist2':[]};
  if(window.store.getState().differential.celllist1){
    cells['celllist1'] = window.store.getState().differential.celllist1;
  }
  if(window.store.getState().differential.celllist2){
    cells['celllist2'] = window.store.getState().differential.celllist2;
  }
  
  if($('#GDcutoff').prop('min')>$("#GDcutoff").val()){
    $('#GDnote').text("The minimal expression level is: "+$('#GDcutoff').prop('min'));
    return;
  }
  return [cells,Math.max($("#GDcutoff").val(),$('#GDcutoff').prop('min'))];
}
function GDload(content){
  cells = content[0];
  var newCells={};
  for(const one in cells){
    var arr=[];
    for(var p in Object.getOwnPropertyNames(cells[one])){
      arr[p]=cells[one][p];
    }
    newCells[one] = new Int32Array(arr);
  }

  for(const one of Object.keys(newCells)){
    if(newCells[one].length>0){
      window.store.getState().differential[one] = newCells[one];
    }else{
      window.store.getState().differential[one] = null;
    }
  }
  $("#GDcutoff").val(content[1]);
  cellNupdate();
}
function MARKsave(){
  return [checkSave('MARKcell'),$("#MARKgrp").val(),$("#MARKmethod").val(),$("#MARKn").val()];
}
function MARKload(content){
  checkLoad('MARKcell',content[0]);
  $("#MARKgrp").val(content[1])
  $("#MARKmethod").val(content[2])
  $("#MARKn").val(content[3])
}
function SGVsave(){
  return [checkSave('SGVcell'),$("#SGVgene").val(),$("#SGVgrp").val(),
          Math.max($("#SGVcutoff").val(),$('#SGVcutoff').prop('min'))];
}
function SGVload(content){
  checkLoad('SGVcell',content[0]);
  $("#SGVgene").val(content[1]);
  $("#SGVgrp").val(content[2]);
  $("#SGVcutoff").val(content[3]);
}
function PGVsave(){
  return [checkSave('PGVcell'),checkSave("PGVgenes"),checkSave('PGVgeneGrp'),
          $("#PGVgrp").val(),$("#PGVgrpXY").val(),
          Math.max($("#PGVcutoff").val(),$('#PGVcutoff').prop('min'))];
}
function PGVload(content){
  checkLoad('PGVcell',content[0]);
  checkLoad('PGVgenes',content[1]);
  checkLoad('PGVgeneGrp',content[2])
  $("#PGVgrp").val(content[3]);
  $("#PGVgrpXY").val(content[4]);
  $("#PGVcutoff").val(content[5]);
}
function HEATsave(){
  return [checkSave('HEATcell'),checkSave("HEATgenes"),$("#HEATorder").val(),checkSave("HEATgrps")];
}
function HEATload(content){
  checkLoad('HEATcell',content[0]);
  checkLoad("HEATgenes",content[1]);
  $("#HEATorder").val(content[2]);
  checkLoad("HEATgrps",content[3]);
}
function EMBEDsave(){
  return [checkSave('EMBEDcell'),checkSave("EMBEDgenes"),checkSave("EMBEDgrps"),
          $("#EMBEDlayout").val(),$('#EMBEDslot').val(),$("#EMBEDsplit").val()];
}
function EMBEDload(content){
  checkLoad('EMBEDcell',content[0]);
  checkLoad("EMBEDgenes",content[1]);
  checkLoad("EMBEDgrps",content[2]);
  $("#EMBEDlayout").val(content[3]);
  $('#EMBEDslot').val(content[4]);
  $('#EMBEDsplit').val(content[5]);
}
function DOTsave(){
  return [checkSave('DOTcell'),checkSave("DOTgenes"),checkSave('DOTgeneGrp'),
          $("#DOTgrp").val(),Math.max($("#DOTcutoff").val(),$('#DOTcutoff').prop('min'))];
}
function DOTload(content){
  checkLoad('DOTcell',content[0]);
  checkLoad("DOTgenes",content[1]);
  checkLoad('DOTgeneGrp',content[2])
  $("#DOTgrp").val(content[3]);
  $("#DOTcutoff").val(content[4]);
}
function TRAKsave(){
  return [checkSave('TRAKcell'),checkSave("TRAKgenes"),$("#TRAKgrp").val(),checkSave("TRAKgeneGrp")];
}
function TRAKload(content){
  checkLoad('TRAKcell',content[0]);
  checkLoad("TRAKgenes",content[1]);
  $("#TRAKgrp").val(content[2]);
  checkLoad("TRAKgeneGrp",content[3]);
}
function DENSsave(){
  return [checkSave('DENScell'),checkSave("DENSgenes"),
          $("#DENSsplit").val(),$("#DENSgrp").val(),
          $("#DENScutoff").val()]
}
function DENSload(content){
  checkLoad('DENScell',content[0]);
  checkLoad('DENSgenes',content[1]);
  $("#DENSsplit").val(content[2]);
  $("#DENSgrp").val(content[3]);
  $("#DENScutoff").val(content[4]);
}
function DUALsave(){
  return [checkSave('DUALcell'),checkSave("DUALgenes"),Math.max($("#DUALcutoff").val(),$('#DUALcutoff').prop('min')),$("#DUALlayout").val()];
}
function DUALload(content){
  checkLoad('DUALcell',content[0]);
  checkLoad("DUALgenes",content[1]);
  $("#DUALcutoff").val(content[2]);
  $("#DUALlayout").val(content[3]);
}
function DEGsave(){
  return [checkSave('DEGgrp'),$("#DEGtop").val(),$("#DEGmethod").val()]
}
function DEGload(content){
  checkLoad('DEGgrp',content[0])
  $("#DEGtop").val(content[1]);
  $("#DEGmethod").val(content[2]);
}
function save(){
  sync();

  var content = ['cellxgene.'+window.store.getState().config.displayNames.dataset];
  content.push(ABBRsave());
  content.push(ADDsave());
  content.push(IMGsave());
  content.push(GDsave());
  content.push(MARKsave());
  content.push(SGVsave());
  content.push(PGVsave());
  content.push(HEATsave());
  content.push(EMBEDsave());
  content.push(DOTsave());
  content.push(TRAKsave());
  content.push(DENSsave());
  content.push(DUALsave());
  content.push(DEGsave());
  
  
  var hiddenE = document.createElement('a');
  hiddenE.href="data:attachment/text,"+encodeURIComponent(JSON.stringify(content));
  hiddenE.target='_blank';
  hiddenE.download='cellxgene.'+window.store.getState().config.displayNames.dataset+'.info.txt';
  hiddenE.click();
}
function inputClick(){
  sync();
  $("#loadfile").trigger('click');
}
function load(){
  var reader = new FileReader();
  reader.onload=function(ev){
    var content = JSON.parse(decodeURIComponent(ev.target.result));
    if(content[0]!='cellxgene.'+window.store.getState().config.displayNames.dataset){
      alert("Saved information is NOT matching with the current data!");
      return;
    }
    var i=1;
    ABBRload(content[i++]);
    ADDload(content[i++]);
    IMGload(content[i++]);
    GDload(content[i++]);
    MARKload(content[i++]);
    SGVload(content[i++]);
    PGVload(content[i++]);
    HEATload(content[i++]);
    EMBEDload(content[i++]);
    DOTload(content[i++]);
    TRAKload(content[i++]);
    DENSload(content[i++]);
    DUALload(content[i++]);
    DEGload(content[i++]);
    alert("Saved information was loaded successfully!\nYou might start with 'Check All Features' in 'Comb. & Abbr.' tab!");
  };
  reader.readAsText($("#loadfile")[0].files[0]);
  
}

</script>
<script type="text/javascript" src="static/DataTables/datatables.min.js"></script>
</body>
</html>
